<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Ragnarök — viking browser with HTML5 parser!</title>
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <link rel="stylesheet" href="/static/css/main.min.css" type="text/css" media="all">
        <!--[if lte IE 8]>
            <link rel="stylesheet" href="/static/css/ie-fixes.css" type="text/css" media="all">
            <script src="/static/js/html5shiv.js"></script>
        <![endif]-->

        <meta http-equiv="last-modified" content="Tue, 22 Feb 2011 15:43:51 GMT">
        <link rel="alternate" type="application/atom+xml" title="All Posts (Atom)" href="/feeds/all.atom">
        <link rel="alternate" type="application/rss+xml" title="All Posts (RSS)" href="/feeds/all.rss">
        <link rel="icon" type="image/jpeg" sizes="287x287" href="/static/img/favicon-287x287.jpg">
        <link rel="icon" type="image/jpeg" sizes="128x128" href="/static/img/favicon-128x128.jpg">
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-2097834-1', 'auto');
            ga('send', 'pageview');
        </script>
    </head>
    <body class="blog post_detail" itemscope itemtype="http://schema.org/BlogPosting">
        <nav id="site-nav">
            <header id="about">
                <h1><a href="/about/">Chris Adams</a></h1>
                <h2>Programmer, cyclist, photographer</h2>
            </header>
            <ul class="links">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about/">About</a>
                </li>
                <li>
                    <a href="/feeds/all.atom" title="Site Feed">Site Feed</a>
                </li>
            </ul>
            <ul class="social-networks">
                <li>
                    <a href="https://github.com/acdha" rel="me">Github</a>
                </li>
                <li>
                    <a href="https://bitbucket.org/acdha" rel="me">Bitbucket</a>
                </li>
                <li>
                    <a href="https://pinboard.in/u:acdha/" rel="me">Pinboard</a>
                </li>
                <li>
                    <a href="https://twitter.com/acdha" rel="me">Twitter</a>
                </li>
                <li>
                    <a href="https://www.flickr.com/photos/acdha" rel="me">Flickr</a>
                </li>
                <li>
                    <a href="https://www.linkedin.com/in/acdha" rel="me">LinkedIn</a>
                </li>
            </ul>
            <div id="site-search"></div>
        </nav>
        <section id="main">
            <article class="post">
                <header>
                    <meta itemprop="dateCreated" content="2011-02-22T10:43:51-04:00">
                    <meta itemprop="dateModified" content="2011-02-22T10:43:51-04:00">
                    <time class="date" itemprop="datePublished" datetime="2011-02-22T14:43:51+00:00">Feb 22</time>
                    <h2 class="" itemprop="title">Ragnarök — viking browser with HTML5 parser!</h2>
                </header>

                <div class="body" itemprop="articleBody"><div class="googlereader description" data-google-id="tag:google.com,2005:reader/item/26184e79a9d1dda4">
                        <blockquote>
                            <div>
                                <p>
                                    Making its debut in a Labs build this week is <a href="http://en.wikipedia.org/wiki/Ragnar%f6k">Ragnarök</a>, our implementation of the HTML5 Parsing algorithm. We'd love you to try to break this and give us feedback, so please grab a copy to install on your machine from one of the download links below.
                                </p>
                                <ul>
                                    <li>
                                        <a href="http://snapshot.opera.com/labs/ragnarok/Opera_1150_24581_en.exe">Opera 11 with new HTML 5 parser for Windows</a>
                                    </li>
                                    <li>
                                        <a href="http://snapshot.opera.com/labs/ragnarok/Opera_11.50_24581.dmg">Opera 11 with new HTML 5 parser for Mac</a>
                                    </li>
                                    <li>
                                        <a href="http://snapshot.opera.com/labs/ragnarok/Linux-FreeBSD/">Opera 11 with new HTML 5 parser for Linux/FreeBSD</a>
                                    </li>
                                </ul>
                                <h2>
                                    The coolest HTML5 demo you'll see this week
                                </h2>
                                <p>
                                    The Web is littered with <code>&lt;canvas&gt;</code> games, HTML5 video players, drag-and-drop whizz-bangs and other demos of HTML5 and "HTML5". But here's a really cool demo, probably the coolest you'll see this week. Are you ready? Here goes:
                                </p>
                                <pre>
<code style="font-size:x-large">&lt;b&gt;&lt;i&gt;Yo!&lt;/b&gt;&lt;/i&gt;
</code>
</pre>
                                <p>
                                    I can tell you're impressed, so let's dig deeper to see exactly why it is so cool. The elements are incorrectly nested: the innermost element - in this case, the <code>&lt;i&gt;</code> - should be the first one closed. What does this do to the DOM in different browsers?
                                </p>
                                <p>
                                    We can check this out using Opera Dragonfly and its equivalents, or <a href="http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C!DOCTYPE%20html%3E%0D%0A%3Cb%3E%3Ci%3EYo!%3C%2Fb%3E%3C%2Fi%3E">Ian Hickson's DOM viewer</a>. Internet Explorer 9 and Safari 5 result in this innerHTML:
                                </p>
                                <pre>
<code>&lt;!DOCTYPE HTML&gt;
&lt;html&gt;&lt;HEAD&gt;&lt;/HEAD&gt;&lt;BODY&gt;
&lt;B&gt;&lt;I&gt;Yo!&lt;/I&gt;&lt;/B&gt;&lt;I&gt;&lt;/I&gt;
&lt;/BODY&gt;&lt;/html&gt;</code>
</pre>
                                <p>
                                    while Opera, Firefox and Chrome produce this:
                                </p>
                                <pre>
<code>&lt;!DOCTYPE HTML&gt;<br>&lt;html&gt;&lt;HEAD&gt;&lt;/HEAD&gt;&lt;BODY&gt;
&lt;B&gt;&lt;I&gt;Yo!&lt;/I&gt;&lt;/B&gt;
&lt;/BODY&gt;&lt;/html&gt;
</code>
</pre>
                                <p>
                                    All the browsers have sorted out the mis-nesting, but inconsistently: note that IE and Safari have an additional empty <code>&lt;i&gt;</code> element that Opera, Firefox and Chrome don't have. Which is correct? In an HTML4 world, both are. The HTML4 spec describes what to do with good markup, but not what to do with bad markup - and we know that <a href="http://dev.opera.com/articles/view/mama-markup-validation-report/">95% of the Web doesn't validate</a>. Therefore, browsers have traditionally been left to their own devices and forced to guess what to do with bad markup, as error-handling was never defined for HTML4.
                                </p>
                                <p>
                                    Our simple markup above already produces very different DOMs, so imagine what would result from more real world examples of tag soup with dozens or hundreds of elements. Writing JavaScript that has to operate across browsers with such inconsistencies is a major cause of hair loss and weeping amongst web developers.
                                </p>
                                <p>
                                    Luckily, there is now a solution to this.
                                </p>
                                <h2>
                                    The HTML5 parsing algorithm
                                </h2>
                                <p>
                                    The HTML5 specification defines a <a href="http://dev.w3.org/html5/spec/parsing.html#parsing">set of parsing rules</a> for all markup, whether valid or invalid. Once all browsers have HTML5 parsers, the same markup will produce the same DOM across all conforming browsers. There are two main effects of this:
                                </p>
                                <ul>
                                    <li>JavaScripters will sport cheerful grins and bouffant hair
                                    </li>
                                    <li>Consumers can expect fewer interoperability problems when using their favourite site between browsers
                                    </li>
                                </ul>
                                <h2>
                                    So validation is a thing of the past, right?
                                </h2>
                                <p>
                                    Absolutely not. It's still a vital QA tool, and just because the HTML5 parser will produce an interoperable DOM, it doesn't mean it's the DOM you actually want!
                                </p>
                                <h2>
                                    Opera's implementation
                                </h2>
                                <p>
                                    Our old HTML parser has basically been the same since Opera began 15 years ago. It's been continually patched to keep up with changing standards and countless different ways people came up with to not follow the specifications. After all the changes here and there, the code really started to look like a over-decorated christmas tree, and adding more stuff without knocking over the tree was getting increasingly hard.
                                </p>
                                <p>
                                    With the decision to rewrite the entire parser came the opportunity to clean up the design significantly.
                                </p>
                                <p>
                                    We can now proudly say that the new Ragnarök parser has a 99.9% pass-rate on an extensive test suite based on the html5lib tests for the parser part of the HTML 5 specification. The missing last 0.1% is going to be fixed before Ragnarök's golden release. The test suite will also be publicly released once completed so that you can verify it yourself and compare Opera to the other browsers out there.
                                </p>
                                <p>
                                    Ragnarök also scores 11 out of 11 (plus two bonus points) on the somewhat non-comprehensive (and therefore rather misleading) <a href="http://html5test.com/">html5test.com</a>. (The two bonus points are for parsing <a href="http://people.opera.com/brucel/articles/html5-mathml-svg.html">embedded SVG and MathML in HTML5</a>.)
                                </p>
                                <h3>
                                    Memory consumption
                                </h3>
                                <p>
                                    The main reason we kept our old parser for so long was its efficient memory usage when handling bad markup. Instead of duplicating nodes like the HTML5 specification states, our parser had a intricate system of pointers that indicated which nodes should have been duplicated. This saved it from allocating memory to actually duplicating the element data, but also made the code that traversed the data structure more complex. Now we have switched to copying the nodes, it uses slightly more memory. Before the final release we will minimize that side effect — Opera has always been about memory efficiency, and working on smaller devices too.
                                </p>
                                <h3>
                                    Performance
                                </h3>
                                <p>
                                    It's not obvious now, because this technical preview isn't optimized for speed like the golden releases will be, but another advantage of the rewrite has been an increase in parser performance. Since the time taken parsing the markup of a page is relatively small compared to loading and rendering, this will not affect benchmarks dramatically, but all performance improvements are for the better, right?
                                </p>
                                <h2>
                                    Get it while it's hot!
                                </h2>
                                <p>
                                    We have made some builds contain the new parser so that you can test it out, right now, and earn the right to brag to your friends that "Hah, I've been running that for quite some time now" when the final product is out in the stores in a short while.
                                </p>
                                <ul>
                                    <li>
                                        <a href="http://snapshot.opera.com/labs/ragnarok/Opera_1150_24581_en.exe">Opera 11 with new HTML 5 parser for Windows</a>
                                    </li>
                                    <li>
                                        <a href="http://snapshot.opera.com/labs/ragnarok/Opera_11.50_24581.dmg">Opera 11 with new HTML 5 parser for Mac</a>
                                    </li>
                                    <li>
                                        <a href="http://snapshot.opera.com/labs/ragnarok/Linux-FreeBSD/">Opera 11 with new HTML 5 parser for Linux/FreeBSD</a>
                                    </li>
                                </ul>
                                <p>
                                    <b>Disclaimer</b>: The builds are only meant as a technical preview of the new parser, and have not gone through the usual thorough testing our golden releases get, so they might be more unstable. The email client is <strong>not</strong> working properly so do not use it. Delayed Script Execution is also unstable at the moment. The builds are not optimized for speed so don't expect any useful results from performance benchmarks yet. Better stats will be available when the final version is out.
                                </p>
                            </div>
                        </blockquote>
                    </div>
                    <p class="bookmark-source">
                        Source: <a href="http://my.opera.com/core/blog/show.dml/26453141">http://my.opera.com/core/blog/show.dml/26453141</a>
                    </p>
                </div>
            </article>

            <nav id="post-nav">


            </nav>

            <script id="discus-javascript">
                var disqus_shortname = 'improbable';

                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                    document.getElementsByTagName('body')[0].appendChild(dsq);
                })();
            </script>

            <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            <div id="disqus_thread"></div>
        </section>

        <footer id="site-footer" class="nocontent">
            <p>
                This site is purely my personal work and does not reflect the views of my employer.
            </p>
            <p class="license">
                <a class="icon" rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/3.0/88x31.png"></a>
                This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.
            </p>
        </footer>

        <script async src="/static/js/common.js"></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/run_prettify.min.js" integrity="sha256-hj+5FRlAuvAFANiefn0PpJYCkV1X4QT9EgiPd+6QnCw=" crossorigin="anonymous"></script>
    </body>
</html>
