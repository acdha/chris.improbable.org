<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>
            Vanity: Experiment Driven Development for Rails
        </title>
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <link rel="stylesheet" href="/static/css/main.min.css" type="text/css" media="all"><!--[if lte IE 8]>
            <link rel="stylesheet" href="/static/css/ie-fixes.css" type="text/css" media="all">
            <script src="/static/js/html5shiv.js"></script>
        <![endif]-->
        <meta http-equiv="last-modified" content="Fri, 20 Nov 2009 01:16:05 GMT">
        <link rel="alternate" type="application/atom+xml" title="All Posts (Atom)" href="/feeds/all.atom">
        <link rel="alternate" type="application/rss+xml" title="All Posts (RSS)" href="/feeds/all.rss">
        <link rel="icon" type="image/jpeg" sizes="287x287" href="/static/img/favicon-287x287.jpg">
        <link rel="icon" type="image/jpeg" sizes="128x128" href="/static/img/favicon-128x128.jpg">
        <script type="application/javascript">
var _prum={id:"5166be01e6e53d1007000001"};var PRUM_EPISODES=PRUM_EPISODES||{};PRUM_EPISODES.q=[];PRUM_EPISODES.mark=function(b,a){PRUM_EPISODES.q.push(["mark",b,a||new Date().getTime()])};PRUM_EPISODES.measure=function(b,a,b){PRUM_EPISODES.q.push(["measure",b,a,b||new Date().getTime()])};PRUM_EPISODES.done=function(a){PRUM_EPISODES.q.push(["done",a])};PRUM_EPISODES.mark("firstbyte");(function(){var b=document.getElementsByTagName("script")[0];var a=document.createElement("script");a.type="text/javascript";a.async=true;a.charset="UTF-8";a.src="//rum-static.pingdom.net/prum.min.js";b.parentNode.insertBefore(a,b)})();
        </script>
    </head>
    <body class="blog post_detail" itemscope itemtype="http://schema.org/BlogPosting">
        <nav id="site-nav">
            <header id="about">
                <h1>
                    <a href="/about/">Chris Adams</a>
                </h1>
                <h2>
                    Programmer, cyclist, photographer
                </h2>
            </header>
            <ul class="links">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about/">About</a>
                </li>
                <li>
                    <a href="/feeds/all.atom" title="Site Feed">Site Feed</a>
                </li>
            </ul>
            <ul class="social-networks">
                <li>
                    <a href="https://github.com/acdha" rel="me">Github</a>
                </li>
                <li>
                    <a href="http://bitbucket.org/acdha" rel="me">Bitbucket</a>
                </li>
                <li>
                    <a href="http://delicious.com/acdha" rel="me">del.icio.us</a>
                </li>
                <li>
                    <a href="http://twitter.com/acdha" rel="me">Twitter</a>
                </li>
                <li>
                    <a href="https://plus.google.com/116562742092842686896?rel=author" rel="me">Google+</a>
                </li>
                <li>
                    <a href="http://www.flickr.com/photos/acdha" rel="me">Flickr</a>
                </li>
                <li>
                    <a href="http://www.linkedin.com/in/acdha" rel="me">LinkedIn</a>
                </li>
                <li>
                    <a href="http://connect.garmin.com/explore?owner=acdha" rel="me">Garmin Connect</a>
                </li>
            </ul>
            <div id="site-search"></div>
        </nav>
        <section id="main">
            <article class="post">
                <header>
                    <meta itemprop="dateCreated" content="2009-11-19T20:16:05-04:00">
                    <meta itemprop="dateModified" content="2009-11-19T20:16:05-04:00"><time class="date" itemprop="datePublished" datetime="2009-11-20T00:16:05+00:00">Nov 20</time>
                    <h2 itemprop="title">
                        Vanity: Experiment Driven Development for Rails
                    </h2>
                </header>
                <div class="body" itemprop="articleBody">
                    <div class="googlereader description" data-google-id="tag:google.com,2005:reader/item/26fca8b0d960c1b9">
                        <blockquote>
                            <p>
                                <img title="sidebar sidebar" src="http://blog.labnotes.org/wp-content/uploads/2009/11/sidebar-sidebar.png" alt="sidebar sidebar" width="500" height="282">
                            </p>
                            <p>
                                You’re sitting in the weekly design review meeting, taking comfort that it’s down to the last agenda item. Bob needs a new feature done by Friday, and it’s a simple one: add two fields to the user registration form asking people to submit their age and zipcode. How much problem can two fields be?
                            </p>
                            <p>
                                Alice quickly points out that each field you add means less registrations. Bob retorts that the new information will lead to better lead qualification, losing a percent or two is “no big deal”. Alice recalls the drop-off per field is much higher than that. Bob is confident people love the service enough to surrender additional data. Alice responds …
                            </p>
                            <p>
                                At the end of an endless list of opinions, personal biases and supposedly relevant anecdotal stories, it all comes down to who’s higher up the org chart. As&nbsp;<a href="http://www.slideshare.net/gvwilson/bits-of-evidence-2338367">Greg Wilson wittingly says</a>:
                            </p>
                            <blockquote>
                                <p>
                                    … even the best of us aren’t doing what we expect the makers of acne creams to do.
                                </p>
                            </blockquote>
                            <p>
                                Opinions are good, but they only get you so far. So are predictions based on other people’s experience. They’re good as a starting point, but the only meaningful numbers are the ones you measure yourself. On your site. With your visitors/customers. From the experiments you designed.
                            </p>
                            <h3>
                                Experiment Driven Development
                            </h3>
                            <p>
                                You’ve got your TDD, your BDD, your load testing, your user testing, your code metrics. All tools for testing your code and improving it. Here’s a question for you: what are you using to test your ideas?
                            </p>
                            <p>
                                <a href="http://blog.talbott.ws/">Nathaniel Talbott</a> came up with <em>Experiment Driven Development</em> to describe the process of testing your ideas and using the data to drive development. My best attempt to summarize EDD in one sentence:
                            </p>
                            <blockquote>
                                <p>
                                    Lay each feature as a hypothesis, write an experiment to prove it, run and collect data, use the conclusion to develop your code.
                                </p>
                            </blockquote>
                            <p>
                                EDD is fact-based software development. It’s the opposite of developing software out of opinions backed by anecdotes based on stories CEO tell about their cousin in-law. EDD starts out with ideas and then measures them against real people: your customers, visitors to your site, dog-food eaters. It seeks proof, and it’s iterative.
                            </p>
                            <p>
                                <img title="IEDI" src="http://blog.labnotes.org/wp-content/uploads/2009/11/IEDI.png" alt="IEDI" width="500" height="255">
                            </p>
                            <p>
                                Where TDD and BDD offer tools that help you improve code quality and make sure you code behaves according to spec, EDD helps you find out what features to develop and where to take them: it helps you discover what will become the spec.
                            </p>
                            <p>
                                If you’re following the <a href="http://www.startuplessonslearned.com/2008/09/lean-startup.html">Lean Startup methodology</a>, you’ll recognize where EDD fits in the customer development cycle. If you’re not, I heartily recommend grabbing a copy of <a href="http://www.amazon.com/gp/product/0976470705">The Four Steps to the Epiphany</a>.
                            </p>
                            <h3>
                                EDD in Practice: Proving Bob Wrong
                            </h3>
                            <p>
                                So let’s switch gears and put Bob’s idea to the test. We’ll start by formulating the new feature as an experiment, and we’ll run an A/B test to decide one way or the other. Our hypothesis is that adding two additional fields (age and zipcode) makes no difference. Let’s write an experiment for that:
                            </p>
                            <pre>
ab_test “Age and Zipcode” do
  description “Change registration form: add age and zipcode fields.”
end
</pre>
                            <p>
                                Visitors to our site will see one of two forms. We’ll make both alternatives available form the same Rails view:
                            </p>
                            <pre>
&lt;% form_for Registration.new do |f| %&gt;
 Your name: &lt;%= f.text_field :name %&gt;
 &lt;% if ab_test(:age_and_zipcode) %&gt;
   Your age:  &lt;%= f.text_field :age %&gt;
   Your zipcode: &lt;%= f.text_field :zipcode %&gt;
 &lt;% end %&gt;
 &lt;%= f.submit “Register” %&gt;
&lt;% end %&gt;
</pre>
                            <p>
                                We’ll need to record each registration, so we can compare how each alternative performed:
                            </p>
                            <pre>
class RegistrationController &lt; ApplicationController
 def register
   @reg = Registration.new(params[:registration])
   if @reg.save
     track! :age_and_zipcode  # registration is our goal
     redirect_to thankyou_url
   else
     render action: “form”
   end
 end
end
</pre>
                            <p>
                                We’ll let this experiment run for a few days, and then look at the results:
                            </p>
                            <p>
                                <img title="Age and zipcode in dashboard" src="http://blog.labnotes.org/wp-content/uploads/2009/11/Age-and-zipcode-in-dashboard.png" alt="Age and zipcode in dashboard" width="500" height="258">
                            </p>
                            <p>
                                Would you have guessed option B performed better? Maybe Bob was right after all.
                            </p>
                            <h3>
                                Testing Your Experiments
                            </h3>
                            <p>
                                Our experiment involves adding two fields to an existing form. What could possibly go wrong?
                            </p>
                            <p>
                                Unless we add these fields to the underlying model, we’re not actually storing new inputs. That’s fine if all we want to know is “would people fill-in their age and zipcode”. What about the hypothesis that says these two fields lead to higher quality leads? To test that, we’ll need to store age and zipcode in the database.
                            </p>
                            <p>
                                So now we have one form that expects both fields, and we’ll want to validate and store their values. We have another form that can’t fail when these two fields are empty. Our goal is to get an A/B test to run, not A/broken, so we’ll make sure both forms work as expected.
                            </p>
                            <p>
                                Let’s test both alternatives:
                            </p>
                            <pre>
class RegistrationControllerTest &lt; ActionController::TestCase
  def test_form_with_one_field
    experiment(:age_and_zipcode).chooses(false)
    . . .
  end

  def test_form_with_three_fields
   experiment(:age_and_zipcode).chooses(true)
    . . .
 end
end
</pre>
                            <p>
                                Antoher benefit that comes from testing your experiments: when we’re done with this experiment, we’ll rip out the definition and all tests that reference the experiment will fail. This will help us find all the places in our code that run the experiment and change them to the chosen behavior.
                            </p>
                            <p>
                                That’s automated testing, now let’s talk about hands-on testing. You’ll want to make sure both forms look good, and there’s no better way than trying them out yourself. For that, we’ll to use the Vanity Dashboard and switch between the alternatives we get to see:
                            </p>
                            <p>
                                <img title="choose from dashboard" src="http://blog.labnotes.org/wp-content/uploads/2009/11/choose-from-dashboard.png" alt="choose from dashboard" width="500" height="204">
                            </p>
                            <h3>
                                Time to Decide
                            </h3>
                            <p>
                                Once we reach a decision it’s time to end the experiment, change our code to apply the winning alternative, run another round of testing, and deploy a new release. Put that on the todo list.
                            </p>
                            <p>
                                Meanwhile we’ll let the experiment conclude itself. It might look like this:
                            </p>
                            <pre>
ab_test “Age and Zipcode” do
  description “Change registration form: add age and zipcode fields.”

  complete_if do
    alternatives.all? { |alt| alt.participants &gt;= 1000 } &amp;&amp;
    score.choice &amp;&amp; score.choice.probability &gt;= 95
  end

end
</pre>
                            <p>
                                This experiment will complete when a) there are at least 1000 participants for each alternative, that’s a big enough sample size, and b) one alternative stands out with probability of 95% or more. (You want to read more about <a href="http://www.cennydd.co.uk/2009/statistical-significance-other-ab-test-pitfalls/">probabilities and interpreting the results</a>)
                            </p>
                            <p>
                                Vanity will then turn the experiment off, stop collecting data, and switch all participants to the chosen alternative. You don’t have to rush to make a new release with the chosen alternative.
                            </p>
                            <p>
                                This may not sound like much, but the less you need to feed and care for each experiment the more experiments you can run. And that means faster iterations and more hard data to improve your application. Cool.
                            </p>
                            <h3 style="font-size:1.17em">
                                How Vanity Came To Be
                            </h3>
                            <p>
                                Before <a href="http://vanity.labnotes.org/">Vanity</a> I used&nbsp;a system I like to call “too many things in too many places”. It had ActiveRecord queries, JavaScript tracking feeding into Google Analytics goals, A/Bingo testing with crontab reports, log grepping, and a lot of knowing how to piece data from different places to make sense of it all.
                            </p>
                            <p>
                                It didn’t scale.
                            </p>
                            <p>
                                Listening to Nathaniel explain EDD, I had a eureka moment … more like euphoria as I imagined all that complexity disappearing into a framework with a clean, simple API. Then came some experimenting to find out which feature I needed, and implementing them one by one.
                            </p>
                            <p>
                                As I ran through these experiments, I came up with a list of what my EDD framework had to do:
                            </p>
                            <p>
                                <strong>Based in code.</strong> I want my experiments to be in source code, checked in source control, I want to edit them with a text editor.
                            </p>
                            <p>
                                <strong>Self-sufficient</strong>. I don’t want to maintain database schema and object models in support of the schema. The framework has to take care of storing its own state, collecting statistics, etc.
                            </p>
                            <p>
                                <strong>Lightweight</strong>. I don’t want to choose between performance and experimenting.
                            </p>
                            <p>
                                <strong>Smart.</strong> Do all the statistic calculations for me. I suck at math.
                            </p>
                            <p>
                                <strong>Integrated.</strong> You can do a lot with changes to HTML content, but some experiments need to reach deep into the application.
                            </p>
                            <p>
                                <strong>Testable</strong><strong>.</strong> I need a way to test experimental code, and if experiment has multiple variants, test them all. A/B testing does not mean A/broken.
                            </p>
                            <p>
                                <strong>Reporting.</strong> I want a pretty UI to look at, also be able to email reports.
                            </p>
                            <p>
                                <strong>Easy on/easy off.</strong> Help me remove experimental code when I’m done experimenting.
                            </p>
                            <p>
                                <strong>Lazy-friendly.</strong> Automate as much as possible, less work for me.
                            </p>
                            <p>
                                <strong>Where to Next?</strong>
                            </p>
                            <p>
                                That’s Experiment Driven Development in short, and a brief introduction to Vanity. If you’re curious, watch <a href="http://rubyconf.org/talks/28-how-tdd-bdd-miss-the-point-introducing-edd">Nathaniel Talbott present EDD at RubyConf ’09</a>.
                            </p>
                            <p>
                                <a href="http://github.com/assaf/vanity">Vanity 1.0</a> is just out the door with support for A/B testing. The next major release will add usage experiments.
                            </p>
                            <p>
                                You can learn more about Vanity on the site <a href="http://vanity.labnotes.org">http://vanity.labnotes.org</a>. The code is on <a href="http://github.com/assaf/vanity">Github</a>, there’s also a <a href="http://groups.google.com/group/vanity-talk">vanity-talk list</a> you’re more than welcome to join. Now, let’s go experiment.
                            </p>
                        </blockquote>
                    </div>
                    <p class="bookmark-source">
                        Source: <a href="http://labnotes.org/2009/11/19/vanity-experiment-driven-development-for-rails/">http://labnotes.org/2009/11/19/vanity-experiment-driven-development-for-rails/</a>
                    </p>
                </div>
            </article>
            <nav id="post-nav"></nav><script id="discus-javascript">
    var disqus_shortname = 'improbable';

                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    document.getElementsByTagName('body')[0].appendChild(dsq);
                })();
            </script><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            <div id="disqus_thread"></div>
        </section>
        <footer id="site-footer">
            <p>
                This site is purely my personal work and does not reflect the views of my employer.
            </p>
            <p class="license">
                <a class="icon" rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png"></a> This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.
            </p>
        </footer><script async="" defer src="/static/js/common.js">
</script><script id="google-analytics">
    var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-2097834-1']);
            _gaq.push(['_setDomainName', 'improbable.org']);
            _gaq.push(['_trackPageview']);

            (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();
        </script>
    </body>
</html>
