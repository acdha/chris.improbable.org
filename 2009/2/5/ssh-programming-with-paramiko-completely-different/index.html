<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>
            SSH Programming with Paramiko | Completely Different
        </title>
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <link rel="stylesheet" href="/static/css/main.min.css" type="text/css" media="all"><!--[if lte IE 8]>
            <link rel="stylesheet" href="/static/css/ie-fixes.css" type="text/css" media="all">
            <script src="/static/js/html5shiv.js"></script>
        <![endif]-->
        <meta http-equiv="last-modified" content="Thu, 05 Feb 2009 15:18:36 GMT">
        <link rel="alternate" type="application/atom+xml" title="All Posts (Atom)" href="/feeds/all.atom">
        <link rel="alternate" type="application/rss+xml" title="All Posts (RSS)" href="/feeds/all.rss">
        <link rel="icon" type="image/jpeg" sizes="287x287" href="/static/img/favicon-287x287.jpg">
        <link rel="icon" type="image/jpeg" sizes="128x128" href="/static/img/favicon-128x128.jpg">
        <script type="application/javascript">
var _prum={id:"5166be01e6e53d1007000001"};var PRUM_EPISODES=PRUM_EPISODES||{};PRUM_EPISODES.q=[];PRUM_EPISODES.mark=function(b,a){PRUM_EPISODES.q.push(["mark",b,a||new Date().getTime()])};PRUM_EPISODES.measure=function(b,a,b){PRUM_EPISODES.q.push(["measure",b,a,b||new Date().getTime()])};PRUM_EPISODES.done=function(a){PRUM_EPISODES.q.push(["done",a])};PRUM_EPISODES.mark("firstbyte");(function(){var b=document.getElementsByTagName("script")[0];var a=document.createElement("script");a.type="text/javascript";a.async=true;a.charset="UTF-8";a.src="//rum-static.pingdom.net/prum.min.js";b.parentNode.insertBefore(a,b)})();
        </script>
    </head>
    <body class="blog post_detail" itemscope itemtype="http://schema.org/BlogPosting">
        <nav id="site-nav">
            <header id="about">
                <h1>
                    <a href="/about/">Chris Adams</a>
                </h1>
                <h2>
                    Programmer, cyclist, photographer
                </h2>
            </header>
            <ul class="links">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about/">About</a>
                </li>
                <li>
                    <a href="/feeds/all.atom" title="Site Feed">Site Feed</a>
                </li>
            </ul>
            <ul class="social-networks">
                <li>
                    <a href="https://github.com/acdha" rel="me">Github</a>
                </li>
                <li>
                    <a href="http://bitbucket.org/acdha" rel="me">Bitbucket</a>
                </li>
                <li>
                    <a href="http://delicious.com/acdha" rel="me">del.icio.us</a>
                </li>
                <li>
                    <a href="http://twitter.com/acdha" rel="me">Twitter</a>
                </li>
                <li>
                    <a href="https://plus.google.com/116562742092842686896?rel=author" rel="me">Google+</a>
                </li>
                <li>
                    <a href="http://www.flickr.com/photos/acdha" rel="me">Flickr</a>
                </li>
                <li>
                    <a href="http://www.linkedin.com/in/acdha" rel="me">LinkedIn</a>
                </li>
                <li>
                    <a href="http://connect.garmin.com/explore?owner=acdha" rel="me">Garmin Connect</a>
                </li>
            </ul>
            <div id="site-search"></div>
        </nav>
        <section id="main">
            <article class="post">
                <header>
                    <meta itemprop="dateCreated" content="2009-02-05T10:18:36-04:00">
                    <meta itemprop="dateModified" content="2009-02-05T10:18:36-04:00"><time class="date" itemprop="datePublished" datetime="2009-02-05T14:18:36+00:00">Feb 05</time>
                    <h2 itemprop="title">
                        SSH Programming with Paramiko | Completely Different
                    </h2>
                </header>
                <div class="body" itemprop="articleBody">
                    <div class="googlereader description" data-google-id="tag:google.com,2005:reader/item/31f4d5db5e719875">
                        <blockquote>
                            <blockquote>
                                <p>
                                    OpenSSH is the ubiquitous method of remote access for secure remote-machine login and file transfers. Many people — systems administrators, test automation engineers, web developers and others have to use and interact with it daily. Scripting SSH access and file transfers with Python can be frustrating — but the Paramiko module solves that in a powerful way.
                                </p>
                            </blockquote>
                            <p>
                                <em>This is a reprint of an article I wrote for <a href="http://www.pythonmagazine.com/">Python Magazine</a> as a Completely Different column that was published in the October 2008 issue. <b>I have republished this in its original form, bugs and all</b></em>
                            </p>
                            <p>
                                SSH is everywhere. OS X, Linux, Solaris, and even Windows offer OpenSSH servers for remote access and file transfers. It long ago displaced other methods of remote access like telnet and rlogin. While those other systems may still exist, their widespread usage has faded with the rapid adoption of the OpenSSH suite of tools.
                            </p>
                            <p>
                                OpenSSH itself is actually a suite of tools based on the ssh2 protocol. The suite provides secure remote login tools (ssh), secure file transfer (scp and sftp), and key management tools.
                            </p>
                            <p>
                                On most operating systems the client-side tools (ssh, scp, sftp) are already installed for users to leverage. Users can also easily install and configure the server-side utilities on systems they want to remotely access.
                            </p>
                            <p>
                                Many, many people use OpenSSH daily, and many of them spend a lot of time trying to script its usage. Most of these tools and scripts try to wrap the command line executables (ssh, scp, etc) directly. They use things like Pexpect to provide passwords, and try to rationalize and parse the output of the binaries directly.
                            </p>
                            <p>
                                Having spent a lot of time scripting around the binaries and trying to manage timeouts, standard out/in/error pipes, authentication, arguments and options all through ‘’subprocess”, ”popen2”, etc., I’m here to tell you wrapping command line binaries is prone to error, difficult to test, and painful to maintain.
                            </p>
                            <p>
                                When you’re in the business of parsing output from command line utilities, watching for exit codes and juggling timeouts, you’re not on a good path. That’s where something like Paramiko comes in.
                            </p>
                            <p>
                                I discovered Paramiko some time ago. It builds on PyCrypto to provide a Python interface to the SSH2 protocol. The module provides all of the faculties you could ask for, including: ssh-key authentication, ssh shell access, and sftp.
                            </p>
                            <p>
                                Since discovering Paramiko, my entire paradigm and usage of SSH has changed. Instead of the frustrating experience of shelling-out and hacking around the various kinks with that, I can programmatically access all of the protocols and tools I need in a clean, Pythonic way.
                            </p>
                            <h3>
                                About Paramiko
                            </h3>
                            <p>
                                Paramiko is a pure-Python module and can be easy_install’ed as other typical python modules can. However, PyCrypto is written largely in C, so you may need a compiler to install both depending on your platform.
                            </p>
                            <p>
                                Paramiko itself has extensive API documentation and an active mailing list. As an added bonus, there’s a Java port of it as well (don’t get me started on controlling SSH within Java) if you need something to achieve the same thing in Java.
                            </p>
                            <p>
                                Paramiko also offers an implementation of the SSH and SFTP server protocols. It really is feature-rich and complete. I’ve used it in heavily threaded applications as well as in day-to-day maintenance scripts. There’s even an installation and deployment system, named Fabric, that further builds on Paramiko to provide application deployment utilities via SSH.
                            </p>
                            <h3>
                                Getting started
                            </h3>
                            <p>
                                The primary class of the Paramiko API is ”paramiko.SSHClient”. It provides the basic interface you are going to want to use to instantiate server connections and file transfers.
                            </p>
                            <p>
                                Here’s a simple example:
                            </p>
                            <div>
                                <span><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" title="WP-CodeBox HowTo?"><span style="color:#99cc00">?</span></a></sup></span><span><a href="javascript:void(0);">View Code</a> PYTHON</span>
                            </div>
                            <div>
                                <table width="100%">
                                    <tr>
                                        <td>
                                            <pre>
1
2
3
4
</pre>
                                        </td>
                                        <td>
                                            <pre style="font-family:monospace">
<span style="color:#ff7700;font-weight:bold">import</span> paramiko
ssh = paramiko.<span style="color:black">SSHClient</span><span style="color:black">(</span><span style="color:black">)</span>
ssh.<span style="color:black">connect</span><span style="color:black">(</span><span style="color:#483d8b">'127.0.0.1'</span>, username=<span style="color:#483d8b">'jesse'</span>, 
    password=<span style="color:#483d8b">'lol'</span><span style="color:black">)</span>
</pre>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <p>
                                This creates a new SSHClient object, and then calls ”connect()” to connect us to the local SSH server. It can’t get much easier than that!
                            </p>
                            <h3>
                                Host Keys
                            </h3>
                            <p>
                                One of the complicating aspects of SSH authentication is <em>host keys</em>. Whenever you make an ssh connection to a remote machine, that host’s key is stored automatically in a file in your home directory called ”.ssh/known_hosts”. If you’ve ever connected to a new host via SSH and seen a message like this:
                            </p>
                            <pre>
The authenticity of host 'localhost (::1)' can't be
established.
RSA key fingerprint is
22:fb:16:3c:24:7f:60:99:4f:f4:57:d6:d1:09:9e:28.
Are you sure you want to continue connecting
(yes/no)?
</pre>
                            <p>
                                and typed “yes” — you’ve added an entry to the ”known_hosts” file. These keys are important because accepting them implies a level of trust of the host. If the key ever changes or is compromised in some way, your client will refuse to connect without notifying you.
                            </p>
                            <p>
                                Paramiko enforces this same rule. You must accept and authorize the use and storage of these keys on a per-host basis. Luckily, rather then having to be prompted for each one, or manage each one individually, you can set a magic policy.
                            </p>
                            <p>
                                The default behavior with an SSHClient object is to refuse to connect to a host (”paramiko.RejectPolicy”) who does not have a key stored in your local ”known_hosts” file. This can become annoying when working in a lab environment where machines come and go and have the operating system reinstalled constantly.
                            </p>
                            <p>
                                Setting the host key policy takes one method call to the ssh client object (’’set_missing_host_key_policy()”), which sets the way you want to manage inbound host keys. If you’re lazy like me, you pass in the ”paramiko.AutoAddPolicy()” which will auto-accept unknown keys.
                            </p>
                            <div>
                                <span><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" title="WP-CodeBox HowTo?"><span style="color:#99cc00">?</span></a></sup></span><span><a href="javascript:void(0);">View Code</a> PYTHON</span>
                            </div>
                            <div>
                                <table width="100%">
                                    <tr>
                                        <td>
                                            <pre>
1
2
3
4
5
6
</pre>
                                        </td>
                                        <td>
                                            <pre style="font-family:monospace">
<span style="color:#ff7700;font-weight:bold">import</span> paramiko
ssh = paramiko.<span style="color:black">SSHClient</span><span style="color:black">(</span><span style="color:black">)</span>
ssh.<span style="color:black">set_missing_host_key_policy</span><span style="color:black">(</span>
    paramiko.<span style="color:black">AutoAddPolicy</span><span style="color:black">(</span><span style="color:black">)</span><span style="color:black">)</span>
ssh.<span style="color:black">connect</span><span style="color:black">(</span><span style="color:#483d8b">'127.0.0.1'</span>, username=<span style="color:#483d8b">'jesse'</span>, 
    password=<span style="color:#483d8b">'lol'</span><span style="color:black">)</span>
</pre>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <p>
                                Of course, don’t do this if you’re working with machines you don’t know or trust! Tools built on Paramiko should make this overly liberal policy a configuration option.
                            </p>
                            <h3>
                                Running Simple Commands
                            </h3>
                            <p>
                                So, now that we’re connected, we should try running a command and getting some output.
                            </p>
                            <p>
                                SSH uses the same type of input, output, and error handles you should be familiar with from other Unix-like applications. Errors are sent to standard error, output goes to standard out, and if you want to send data back to the application, you write it to standard in.
                            </p>
                            <p>
                                So, the response data from client commands are going to come back in a tuple - (stdin, stdout, stderr) - which are file-like objects you can read from (or write to, in the case of stdin). For example:
                            </p>
                            <div>
                                <span><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" title="WP-CodeBox HowTo?"><span style="color:#99cc00">?</span></a></sup></span><span><a href="javascript:void(0);">View Code</a> PYTHON</span>
                            </div>
                            <div>
                                <table width="100%">
                                    <tr>
                                        <td>
                                            <pre>
1
2
3
4
5
6
7
8
9
</pre>
                                        </td>
                                        <td>
                                            <pre style="font-family:monospace">
...
<span style="color:#66cc66">&gt;&gt;&gt;</span> ssh.<span style="color:black">connect</span><span style="color:black">(</span><span style="color:#483d8b">'127.0.0.1'</span>, username=<span style="color:#483d8b">'jesse'</span>, 
...    <span style="color:black">password</span>=<span style="color:#483d8b">'lol'</span><span style="color:black">)</span>
<span style="color:#66cc66">&gt;&gt;&gt;</span> stdin, stdout, stderr = \
...    <span style="color:black">ssh</span>.<span style="color:black">exec_command</span><span style="color:black">(</span><span style="color:#483d8b">"uptime"</span><span style="color:black">)</span>
<span style="color:#66cc66">&gt;&gt;&gt;</span> <span style="color:#008000">type</span><span style="color:black">(</span>stdin<span style="color:black">)</span>
<span style="color:#66cc66">&lt;</span>class <span style="color:#483d8b">'paramiko.ChannelFile'</span><span style="color:#66cc66">&gt;</span>
<span style="color:#66cc66">&gt;&gt;&gt;</span> stdout.<span style="color:black">readlines</span><span style="color:black">(</span><span style="color:black">)</span>
<span style="color:black">[</span><span style="color:#483d8b">'13:35  up 11 days,  3:13, 4 users, load averages: 0.14 0.18 0.16<span style="color:#000099;font-weight:bold">\n</span>'</span><span style="color:black">]</span>
</pre>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <p>
                                Under the covers, Paramiko has opened a new ”paramiko.Channel” object which represents the secure tunnel to the remote host. The Channel object acts like a normal python socket object. When we call ”exec_command()”, the Channel to the host is opened, and we are handed back ”paramiko.ChannelFile” “file-like” objects which represents the data sent to and from the remote host.
                            </p>
                            <p>
                                One of the documented nits with the ChannelFile objects paramiko passes back to you is that you need to constantly ”read()” off of the stderr and stdout handles given back to you. If the remote host sends back enough data to fill the buffer, the host will hang waiting for your program to read more. A way around this is to either call ”readlines()” as we did above, or ”read()”. If you need to internally buffer the data, you can also iterate over the object with ”readline()”.
                            </p>
                            <p>
                                This is the simplest form of connecting and running a command to get the output back. For many sysadmin tasks, this will be invaluable as you need to parse the output of a returned command to find exactly what you need. With Python’s rich string manipulation, this is an easy task. Let’s run something with a lot of output, that also requires a password:
                            </p>
                            <div>
                                <span><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" title="WP-CodeBox HowTo?"><span style="color:#99cc00">?</span></a></sup></span><span><a href="javascript:void(0);">View Code</a> PYTHON</span>
                            </div>
                            <div>
                                <table width="100%">
                                    <tr>
                                        <td>
                                            <pre>
1
2
3
4
</pre>
                                        </td>
                                        <td>
                                            <pre style="font-family:monospace">
ssh.<span style="color:black">connect</span><span style="color:black">(</span><span style="color:#483d8b">'127.0.0.1'</span>, username=<span style="color:#483d8b">'jesse'</span>, 
   password=<span style="color:#483d8b">'lol'</span><span style="color:black">)</span>
stdin, stdout, stderr = ssh.<span style="color:black">exec_command</span><span style="color:black">(</span>
   <span style="color:#483d8b">"sudo dmesg"</span><span style="color:black">)</span>
</pre>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <p>
                                Uh oh. I just called the sudo command. It is going to require me to provide a password interactively with the remote host. No worries:
                            </p>
                            <div>
                                <span><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" title="WP-CodeBox HowTo?"><span style="color:#99cc00">?</span></a></sup></span><span><a href="javascript:void(0);">View Code</a> PYTHON</span>
                            </div>
                            <div>
                                <table width="100%">
                                    <tr>
                                        <td>
                                            <pre>
1
2
3
4
5
6
7
8
9
10
</pre>
                                        </td>
                                        <td>
                                            <pre style="font-family:monospace">
ssh.<span style="color:black">connect</span><span style="color:black">(</span><span style="color:#483d8b">'127.0.0.1'</span>, username=<span style="color:#483d8b">'jesse'</span>, 
    password=<span style="color:#483d8b">'lol'</span><span style="color:black">)</span>
stdin, stdout, stderr = ssh.<span style="color:black">exec_command</span><span style="color:black">(</span>
    <span style="color:#483d8b">"sudo dmesg"</span><span style="color:black">)</span>
stdin.<span style="color:black">write</span><span style="color:black">(</span><span style="color:#483d8b">'lol<span style="color:#000099;font-weight:bold">\n</span>'</span><span style="color:black">)</span>
stdin.<span style="color:black">flush</span><span style="color:black">(</span><span style="color:black">)</span>
data = stdout.<span style="color:black">read</span>.<span style="color:black">splitlines</span><span style="color:black">(</span><span style="color:black">)</span>
<span style="color:#ff7700;font-weight:bold">for</span> line <span style="color:#ff7700;font-weight:bold">in</span> data:
    <span style="color:#ff7700;font-weight:bold">if</span> line.<span style="color:black">split</span><span style="color:black">(</span><span style="color:#483d8b">':'</span><span style="color:black">)</span><span style="color:black">[</span><span style="color:#ff4500">0</span><span style="color:black">]</span> == <span style="color:#483d8b">'AirPort'</span>:
        <span style="color:#ff7700;font-weight:bold">print</span> line
</pre>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <p>
                                There! I logged in remotely and found all messages for my Airport card. The key thing to note here is that I wrote my password to the stdin “file” so that sudo allowed me in.
                            </p>
                            <p>
                                If you’re wondering, yes, this provides an easy base to create your own interactive shell. You might want to do something like this to make a little custom admin shell using the Python cmd module to administer machines inside of your lab.
                            </p>
                            <p>
                                Using Paramiko, this is easy. In Listing 1, I outline a basic way to approach this - we wrap the Paramiko manipulation up in the RunCommand methods, allowing the user to add as many hosts as they want, call connect and then run a command.
                            </p>
                            <p>
                                Listing 1:
                            </p>
                            <div>
                                <span><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" title="WP-CodeBox HowTo?"><span style="color:#99cc00">?</span></a></sup></span><span><a href="javascript:void(0);">View Code</a> PYTHON</span>
                            </div>
                            <div>
                                <table width="100%">
                                    <tr>
                                        <td>
                                            <pre>
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre>
                                        </td>
                                        <td>
                                            <pre style="font-family:monospace">
<span style="color:#808080;font-style:italic">#!/usr/bin/python</span>
 
<span style="color:#ff7700;font-weight:bold">import</span> paramiko
<span style="color:#ff7700;font-weight:bold">import</span> <span style="color:#dc143c">cmd</span>
 
<span style="color:#ff7700;font-weight:bold">class</span> RunCommand<span style="color:black">(</span><span style="color:#dc143c">cmd</span>.<span style="color:black">Cmd</span><span style="color:black">)</span>:
    <span style="color:#483d8b">""" Simple shell to run a command on the host """</span>
 
    prompt = <span style="color:#483d8b">'ssh &gt; '</span>
 
    <span style="color:#ff7700;font-weight:bold">def</span> <span style="color:#0000cd">__init__</span><span style="color:black">(</span><span style="color:#008000">self</span><span style="color:black">)</span>:
        <span style="color:#dc143c">cmd</span>.<span style="color:black">Cmd</span>.<span style="color:#0000cd">__init__</span><span style="color:black">(</span><span style="color:#008000">self</span><span style="color:black">)</span>
        <span style="color:#008000">self</span>.<span style="color:black">hosts</span> = <span style="color:black">[</span><span style="color:black">]</span>
        <span style="color:#008000">self</span>.<span style="color:black">connections</span> = <span style="color:black">[</span><span style="color:black">]</span>
 
    <span style="color:#ff7700;font-weight:bold">def</span> do_add_host<span style="color:black">(</span><span style="color:#008000">self</span>, args<span style="color:black">)</span>:
        <span style="color:#483d8b">"""add_host &lt;host,user,password&gt;
        Add the host to the host list"""</span>
        <span style="color:#ff7700;font-weight:bold">if</span> args:
            <span style="color:#008000">self</span>.<span style="color:black">hosts</span>.<span style="color:black">append</span><span style="color:black">(</span>args.<span style="color:black">split</span><span style="color:black">(</span><span style="color:#483d8b">','</span><span style="color:black">)</span><span style="color:black">)</span>
        <span style="color:#ff7700;font-weight:bold">else</span>:
            <span style="color:#ff7700;font-weight:bold">print</span> <span style="color:#483d8b">"usage: host &lt;hostip,user,password&gt;"</span>
 
    <span style="color:#ff7700;font-weight:bold">def</span> do_connect<span style="color:black">(</span><span style="color:#008000">self</span>, args<span style="color:black">)</span>:
        <span style="color:#483d8b">"""Connect to all hosts in the hosts list"""</span>
        <span style="color:#ff7700;font-weight:bold">for</span> host <span style="color:#ff7700;font-weight:bold">in</span> <span style="color:#008000">self</span>.<span style="color:black">hosts</span>:
            client = paramiko.<span style="color:black">SSHClient</span><span style="color:black">(</span><span style="color:black">)</span>
            client.<span style="color:black">set_missing_host_key_policy</span><span style="color:black">(</span>
                paramiko.<span style="color:black">AutoAddPolicy</span><span style="color:black">(</span><span style="color:black">)</span><span style="color:black">)</span>
            client.<span style="color:black">connect</span><span style="color:black">(</span>host<span style="color:black">[</span><span style="color:#ff4500">0</span><span style="color:black">]</span>, 
                username=host<span style="color:black">[</span><span style="color:#ff4500">1</span><span style="color:black">]</span>, 
                password=host<span style="color:black">[</span><span style="color:#ff4500">2</span><span style="color:black">]</span><span style="color:black">)</span>
            <span style="color:#008000">self</span>.<span style="color:black">connections</span>.<span style="color:black">append</span><span style="color:black">(</span>client<span style="color:black">)</span>
 
    <span style="color:#ff7700;font-weight:bold">def</span> do_run<span style="color:black">(</span><span style="color:#008000">self</span>, command<span style="color:black">)</span>:
        <span style="color:#483d8b">"""run &lt;command&gt;
        Execute this command on all hosts in the list"""</span>
        <span style="color:#ff7700;font-weight:bold">if</span> command:
            <span style="color:#ff7700;font-weight:bold">for</span> host, conn <span style="color:#ff7700;font-weight:bold">in</span> <span style="color:#008000">zip</span><span style="color:black">(</span><span style="color:#008000">self</span>.<span style="color:black">hosts</span>, <span style="color:#008000">self</span>.<span style="color:black">connections</span><span style="color:black">)</span>:
                stdin, stdout, stderr = conn.<span style="color:black">exec_command</span><span style="color:black">(</span>command<span style="color:black">)</span>
                stdin.<span style="color:black">close</span><span style="color:black">(</span><span style="color:black">)</span>
                <span style="color:#ff7700;font-weight:bold">for</span> line <span style="color:#ff7700;font-weight:bold">in</span> stdout.<span style="color:black">read</span><span style="color:black">(</span><span style="color:black">)</span>.<span style="color:black">splitlines</span><span style="color:black">(</span><span style="color:black">)</span>:
                    <span style="color:#ff7700;font-weight:bold">print</span> <span style="color:#483d8b">'host: %s: %s'</span> <span style="color:#66cc66">%</span> <span style="color:black">(</span>host<span style="color:black">[</span><span style="color:#ff4500">0</span><span style="color:black">]</span>, line<span style="color:black">)</span>
        <span style="color:#ff7700;font-weight:bold">else</span>:
            <span style="color:#ff7700;font-weight:bold">print</span> <span style="color:#483d8b">"usage: run &lt;command&gt;"</span>
 
    <span style="color:#ff7700;font-weight:bold">def</span> do_close<span style="color:black">(</span><span style="color:#008000">self</span>, args<span style="color:black">)</span>:
        <span style="color:#ff7700;font-weight:bold">for</span> conn <span style="color:#ff7700;font-weight:bold">in</span> <span style="color:#008000">self</span>.<span style="color:black">connections</span>:
            conn.<span style="color:black">close</span><span style="color:black">(</span><span style="color:black">)</span>
 
<span style="color:#ff7700;font-weight:bold">if</span> __name__ == <span style="color:#483d8b">'__main__'</span>:
    RunCommand<span style="color:black">(</span><span style="color:black">)</span>.<span style="color:black">cmdloop</span><span style="color:black">(</span><span style="color:black">)</span>
</pre>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <p>
                                Example output:
                            </p>
                            <pre>
ssh &gt; add_host 127.0.0.1,jesse,lol
ssh &gt; connect
ssh &gt; run uptime
host: 127.0.0.1: 14:49  up 11 days,  4:27, 8 users,
load averages: 0.36 0.25 0.19
ssh &gt; close
</pre>
                            <p>
                                This is just designed to be a proof-of concept of a pseudo-interactive shell. There are a few improvements you could make should you use it:
                            </p>
                            <p>
                                - Better printing for multi-line stdout output.<br>
                                - Handle standard error<br>
                                - Add in a quit method<br>
                                - Thread the command execution/data returned.
                            </p>
                            <p>
                                Like all shells, the sky is the limit when it comes to data visualization. Tools like pssh, OSH, Fabric, etc., all manage the return data differently, and they all have different ways of aggregating the output from different hosts.
                            </p>
                            <h3>
                                File put and get
                            </h3>
                            <p>
                                File manipulation within Paramiko is handled via the SFTP implementation, and, like the ssh client command execution, it’s easy as pie.
                            </p>
                            <p>
                                We start by instantiating a new paramiko.SSHClient just as before:
                            </p>
                            <div>
                                <span><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" title="WP-CodeBox HowTo?"><span style="color:#99cc00">?</span></a></sup></span><span><a href="javascript:void(0);">View Code</a> PYTHON</span>
                            </div>
                            <div>
                                <table width="100%">
                                    <tr>
                                        <td>
                                            <pre>
1
2
3
4
5
6
</pre>
                                        </td>
                                        <td>
                                            <pre style="font-family:monospace">
<span style="color:#ff7700;font-weight:bold">import</span> paramiko
ssh = paramiko.<span style="color:black">SSHClient</span><span style="color:black">(</span><span style="color:black">)</span>
ssh.<span style="color:black">set_missing_host_key_policy</span><span style="color:black">(</span>
    paramiko.<span style="color:black">AutoAddPolicy</span><span style="color:black">(</span><span style="color:black">)</span><span style="color:black">)</span>
ssh.<span style="color:black">connect</span><span style="color:black">(</span><span style="color:#483d8b">'127.0.0.1'</span>, username=<span style="color:#483d8b">'jesse'</span>, 
    password=<span style="color:#483d8b">'lol'</span><span style="color:black">)</span>
</pre>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <p>
                                This time, we make a call into ”open_sftp()” after we perform the connect to the host. ”open_sftp()” returns a ”paramiko.SFTPClient” client object that supports all of the normal sftp operations (stat, put, get, etc.). In this example, we perform a “get” operation to download the file ”remotefile.py” from the remote system and write it to to the local file, ”localfile.py”.
                            </p>
                            <p>
                                <code><br>
                                ftp = ssh.open_sftp()<br>
                                ftp.get('remotefile.py', 'localfile.py')<br>
                                ftp.close()<br></code>
                            </p>
                            <p>
                                Writing a file to the remote host (a “put” operation) works the exact same way. We just transpose the local and remote arguments:
                            </p>
                            <div>
                                <span><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" title="WP-CodeBox HowTo?"><span style="color:#99cc00">?</span></a></sup></span><span><a href="javascript:void(0);">View Code</a> PYTHON</span>
                            </div>
                            <div>
                                <table width="100%">
                                    <tr>
                                        <td>
                                            <pre>
1
2
3
</pre>
                                        </td>
                                        <td>
                                            <pre style="font-family:monospace">
ftp = ssh.<span style="color:black">open_sftp</span><span style="color:black">(</span><span style="color:black">)</span>
ftp.<span style="color:black">get</span><span style="color:black">(</span><span style="color:#483d8b">'localfile.py'</span>, <span style="color:#483d8b">'remotefile.py'</span><span style="color:black">)</span>
ftp.<span style="color:black">close</span><span style="color:black">(</span><span style="color:black">)</span>
</pre>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <p>
                                The nice thing about the sftp client implementation that Paramiko provides is that it support things like stat, chmod, chown, etc. Obviously these might act differently depending on the remote server because some servers do not implement all of the protocol, but even so they’re incredibly useful.
                            </p>
                            <p>
                                You could easily write functions like ”glob.glob()” to transverse a remote directory tree looking for a particular filename pattern. You could also search based on permissions, size, etc.
                            </p>
                            <p>
                                One thing to note, however, and this bit me a few times: sftp as a protocol is slightly more restrictive than something like normal secure copy (scp). SCP allows you to use Unix wild cards in the file name when grabbing a file from the remote machine. SFTP, on the other hand, expects the full explicit path to the file you want to download. An example of this is:
                            </p>
                            <div>
                                <span><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" title="WP-CodeBox HowTo?"><span style="color:#99cc00">?</span></a></sup></span><span><a href="javascript:void(0);">View Code</a> PYTHON</span>
                            </div>
                            <div>
                                <table width="100%">
                                    <tr>
                                        <td>
                                            <pre>
1
</pre>
                                        </td>
                                        <td>
                                            <pre style="font-family:monospace">
ftp.<span style="color:black">get</span><span style="color:black">(</span><span style="color:#483d8b">'*.py'</span>, <span style="color:#483d8b">'.'</span><span style="color:black">)</span>
</pre>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <p>
                                In most cases, this would mean “download all files with .py” to the local directory on my machine. SFTP is unhappy with this formulation, though (see Listing 2). I learned this the hard way, after I spent several hours pulling apart the sftp client implementation out of frustration.
                            </p>
                            <p>
                                Listing 2:
                            </p>
                            <div>
                                <span><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" title="WP-CodeBox HowTo?"><span style="color:#99cc00">?</span></a></sup></span><span><a href="javascript:void(0);">View Code</a> PYTHON</span>
                            </div>
                            <div>
                                <table width="100%">
                                    <tr>
                                        <td>
                                            <pre>
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre>
                                        </td>
                                        <td>
                                            <pre style="font-family:monospace">
<span style="color:#66cc66">&gt;&gt;&gt;</span> ftp.<span style="color:black">get</span><span style="color:black">(</span><span style="color:#483d8b">"./*.py"</span>, <span style="color:#483d8b">'.'</span><span style="color:black">)</span>
Traceback <span style="color:black">(</span>most recent call last<span style="color:black">)</span>:
  File <span style="color:#483d8b">"&lt;stdin&gt;"</span>, line <span style="color:#ff4500">1</span>, <span style="color:#ff7700;font-weight:bold">in</span> <span style="color:#66cc66">&lt;</span>module<span style="color:#66cc66">&gt;</span>
  File <span style="color:#483d8b">"/Library/Python/2.5/site-packages/paramiko/sftp_client.py"</span>, 
    line <span style="color:#ff4500">567</span>, <span style="color:#ff7700;font-weight:bold">in</span> get
    fr = <span style="color:#008000">self</span>.<span style="color:#008000">file</span><span style="color:black">(</span>remotepath, <span style="color:#483d8b">'rb'</span><span style="color:black">)</span>
  File <span style="color:#483d8b">"/Library/Python/2.5/site-packages/paramiko/sftp_client.py"</span>, 
    line <span style="color:#ff4500">238</span>, <span style="color:#ff7700;font-weight:bold">in</span> <span style="color:#008000">open</span>
    t, msg = <span style="color:#008000">self</span>._request<span style="color:black">(</span>CMD_OPEN, filename, imode, attrblock<span style="color:black">)</span>
  File <span style="color:#483d8b">"/Library/Python/2.5/site-packages/paramiko/sftp_client.py"</span>, 
    line <span style="color:#ff4500">589</span>, <span style="color:#ff7700;font-weight:bold">in</span> _request
    <span style="color:#ff7700;font-weight:bold">return</span> <span style="color:#008000">self</span>._read_response<span style="color:black">(</span>num<span style="color:black">)</span>
  File <span style="color:#483d8b">"/Library/Python/2.5/site-packages/paramiko/sftp_client.py"</span>, 
    line <span style="color:#ff4500">636</span>, <span style="color:#ff7700;font-weight:bold">in</span> _read_response
    <span style="color:#008000">self</span>._convert_status<span style="color:black">(</span>msg<span style="color:black">)</span>
  File <span style="color:#483d8b">"/Library/Python/2.5/site-packages/paramiko/sftp_client.py"</span>, 
    line <span style="color:#ff4500">662</span>, <span style="color:#ff7700;font-weight:bold">in</span> _convert_status
    <span style="color:#ff7700;font-weight:bold">raise</span> <span style="color:#008000">IOError</span><span style="color:black">(</span><span style="color:#dc143c">errno</span>.<span style="color:black">ENOENT</span>, text<span style="color:black">)</span>
<span style="color:#008000">IOError</span>: <span style="color:black">[</span>Errno <span style="color:#ff4500">2</span><span style="color:black">]</span> No such <span style="color:#008000">file</span>
</pre>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <h3>
                                In Closing
                            </h3>
                            <p>
                                I hope I’ve shown you enough to really dig into Paramiko. It’s one of the gems from the Python community that helps me on a daily basis. I can do remote administration programmatically, write test plugins that perform remote operations easily, and a lot more, all without needing to install extra daemons on the remote machines.
                            </p>
                            <p>
                                SSH is everywhere, and sooner or later you’re going to need to write a program that interacts with it. Why not save yourself the trouble now and give Paramiko a look?
                            </p>
                            <h3>
                                Related Links
                            </h3>
                            <div style="margin-left: 2em">
                                OpenSSH - <a href="http://www.openssh.com/">http://www.openssh.com/</a><br>
                                Pexpect - <a href="http://www.noah.org/wiki/Pexpect">http://www.noah.org/wiki/Pexpect</a><br>
                                Fabric - <a href="http://www.nongnu.org/fab/">http://www.nongnu.org/fab/</a><br>
                                Paramiko Docs - <a href="http://www.lag.net/paramiko/docs/">http://www.lag.net/paramiko/docs/</a><br>
                                Paramiko Mailing List - <a href="http://www.lag.net/mailman/listinfo/paramiko">http://www.lag.net/mailman/listinfo/paramiko</a><br>
                                OSH - <a href="http://geophile.com/osh/">http://geophile.com/osh/</a><br>
                                PSSH - <a href="http://www.theether.org/pssh/">http://www.theether.org/pssh/</a>
                            </div>
                        </blockquote>
                    </div>
                    <p class="bookmark-source">
                        Source: <a href="http://jessenoller.com/2009/02/05/ssh-programming-with-paramiko-completely-different/?utm_source=feedburner&amp;utm_medium=feed&amp;utm_campaign=Feed%3A+Jessenollercom+%28jessenoller.com%29">http://jessenoller.com/2009/02/05/ssh-programming-with-paramiko-completely-different/?utm_source=feedburner&amp;utm_medium=feed&amp;utm_campaign=Feed%3A+Jessenollercom+%28jessenoller.com%29</a>
                    </p>
                </div>
            </article>
            <nav id="post-nav"></nav><script id="discus-javascript">
    var disqus_shortname = 'improbable';

                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    document.getElementsByTagName('body')[0].appendChild(dsq);
                })();
            </script><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            <div id="disqus_thread"></div>
        </section>
        <footer id="site-footer" class="nocontent">
            <p>
                This site is purely my personal work and does not reflect the views of my employer.
            </p>
            <p class="license">
                <a class="icon" rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png"></a> This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.
            </p>
        </footer><script async="" defer src="/static/js/common.js">
</script><script id="google-analytics">
    var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-2097834-1']);
            _gaq.push(['_setDomainName', 'improbable.org']);
            _gaq.push(['_trackPageview']);

            (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();
        </script>
    </body>
</html>
