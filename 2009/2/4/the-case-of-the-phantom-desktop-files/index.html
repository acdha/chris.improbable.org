<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>The Case of the Phantom Desktop Files</title>
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <link rel="stylesheet" href="/static/css/main.min.css" type="text/css" media="all">
        <!--[if lte IE 8]>
            <link rel="stylesheet" href="/static/css/ie-fixes.css" type="text/css" media="all">
            <script src="/static/js/html5shiv.js"></script>
        <![endif]-->

        <meta http-equiv="last-modified" content="Wed, 04 Feb 2009 23:09:06 GMT">
        <link rel="alternate" type="application/atom+xml" title="All Posts (Atom)" href="/feeds/all.atom">
        <link rel="alternate" type="application/rss+xml" title="All Posts (RSS)" href="/feeds/all.rss">
        <link rel="icon" type="image/jpeg" sizes="287x287" href="/static/img/favicon-287x287.jpg">
        <link rel="icon" type="image/jpeg" sizes="128x128" href="/static/img/favicon-128x128.jpg">
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-2097834-1', 'auto');
            ga('send', 'pageview');
        </script>
    </head>
    <body class="blog post_detail" itemscope itemtype="http://schema.org/BlogPosting">
        <nav id="site-nav">
            <header id="about">
                <h1><a href="/about/">Chris Adams</a></h1>
                <h2>Programmer, cyclist, photographer</h2>
            </header>
            <ul class="links">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about/">About</a>
                </li>
                <li>
                    <a href="/feeds/all.atom" title="Site Feed">Site Feed</a>
                </li>
            </ul>
            <ul class="social-networks">
                <li>
                    <a href="https://github.com/acdha" rel="me">Github</a>
                </li>
                <li>
                    <a href="https://bitbucket.org/acdha" rel="me">Bitbucket</a>
                </li>
                <li>
                    <a href="https://pinboard.in/u:acdha/" rel="me">Pinboard</a>
                </li>
                <li>
                    <a href="https://twitter.com/acdha" rel="me">Twitter</a>
                </li>
                <li>
                    <a href="https://www.flickr.com/photos/acdha" rel="me">Flickr</a>
                </li>
                <li>
                    <a href="https://www.linkedin.com/in/acdha" rel="me">LinkedIn</a>
                </li>
            </ul>
            <div id="site-search"></div>
        </nav>
        <section id="main">
            <article class="post">
                <header>
                    <meta itemprop="dateCreated" content="2009-02-04T18:09:06-04:00">
                    <meta itemprop="dateModified" content="2009-02-04T18:09:06-04:00">
                    <time class="date" itemprop="datePublished" datetime="2009-02-04T22:09:06+00:00">Feb 04</time>
                    <h2 class="" itemprop="title">The Case of the Phantom Desktop Files</h2>
                </header>

                <div class="body" itemprop="articleBody"><div class="googlereader description" data-google-id="tag:google.com,2005:reader/item/2e4694994d0091e3">
                        <p class="annotation">
                            Several of Russinovitch's recent posts have had a certain annoying girls-can't-grok-tech vibe - and it's kind of interesting seeing that the solution is <b>obviously</b> to demonstrate your l33t tech ninja skills, rather than question whether it should be necessary to have advanced debugging skills and knowledge of Microsoft's patchwork security kludges simply to manage your documents.<br>
                            <br>
                            I suspect that this will end up as a one-time Explorer special-case which everyone else will be expected to copy rather than a motivation for simplifying the security model. As an open-source fan and Apple shareholder I suppose I should be applauding this but I really wouldn't wish Windows on anyone…
                        </p>
                        <blockquote>
                            <p>
                                A few weeks ago, my wife mentioned that she sometimes saw files in her desktop folder that didn’t appear on the actual desktop. She brought it up not only because she was confused by the discrepancy, but because she wanted to move some of these phantom files to other folders and wanted to delete others. I had no idea what she was talking about (which was usually the case when she described her computer troubles), so I told her that the next time she saw these mysterious files, to call me to look at it.
                            </p>
                            <p>
                                A few days later I got home from work and she greeted me excitedly at the door and explained that the problem reoccurred and that she had left a window open showing the elusive files. I rushed to the kitchen computer with anticipation, not even bothering to greet the dogs on the way, and surveyed the situation. She had a maximized IE window open with a full row of tabs for her open emails (I don’t think she ever closes an email window). An IE “Choose a File” dialog box was in the foreground listing the files in her desktop folder, which she had opened by clicking the attachment button in the email editor. The dialog looked like this:
                            </p>
                            <p>
                                <a href="http://blogs.technet.com/blogfiles/markrussinovich/WindowsLiveWriter/TheCaseofthePhantomDesktopFiles_4A85/image_10.png"><img style="border-right-width:0px;display:inline;border-top-width:0px;border-bottom-width:0px;border-left-width:0px" title="image" border="0" alt="image" src="http://blogs.technet.com/blogfiles/markrussinovich/WindowsLiveWriter/TheCaseofthePhantomDesktopFiles_4A85/image_thumb_4.png" width="420" height="245"></a>
                            </p>
                            <p>
                                I minimized IE to view the desktop background and sure enough, several of the files visible in the dialog, such as the “Maui Feb. 08” folder and the CIMG13xx JPG files, were missing. I opened an Explorer window and navigated to her desktop folder to see if the files would show up there, but they were missing there as well:
                            </p>
                            <p>
                                <a href="http://blogs.technet.com/blogfiles/markrussinovich/WindowsLiveWriter/TheCaseofthePhantomDesktopFiles_4A85/image_6.png"><img style="border-right-width:0px;display:inline;border-top-width:0px;border-bottom-width:0px;border-left-width:0px" title="image" border="0" alt="image" src="http://blogs.technet.com/blogfiles/markrussinovich/WindowsLiveWriter/TheCaseofthePhantomDesktopFiles_4A85/image_thumb_2.png" width="422" height="265"></a>
                            </p>
                            <p>
                                I’d never seen that behavior before. I knew this was a job for Process Monitor. Since my wife doesn’t keep the Sysinternals tools on her system (sad, but true), I ran it directly from the network using the Sysinternals Live address, <a href="javascript:void(0);">\\live.sysinternals.com\tools\procmon.exe</a>. With Process Monitor recording activity, I closed and reopened the Choose File dialog from the email editor and then I search for “CIMG”, a portion of the file name for many of the files present in the Choose File dialog, but not in the Explorer view of the desktop. The first hit was a directory enumeration operation with the file names showing as results in the Details column on the far right:
                            </p>
                            <p>
                                <a href="http://blogs.technet.com/blogfiles/markrussinovich/WindowsLiveWriter/TheCaseofthePhantomDesktopFiles_4A85/image_26.png"><img style="border-right-width:0px;display:inline;border-top-width:0px;border-bottom-width:0px;border-left-width:0px" title="image" border="0" alt="image" src="http://blogs.technet.com/blogfiles/markrussinovich/WindowsLiveWriter/TheCaseofthePhantomDesktopFiles_4A85/image_thumb_12.png" width="554" height="72"></a>
                            </p>
                            <p>
                                The files were located in her profile under \Appdata\Local\Microsoft\Windows\Temporary Internet Files\Virtualized\C\Users\Daryl\Desktop. This Virtualized directory created by IE7 when run in Protected Mode (PMIE), which is the default mode on Windows Vista and Windows Server 2008.
                            </p>
                            <p>
                                PMIE uses Integrity Levels, introduced in Vista and Server 2008, to limit the file system and registry locations to which code running in IE can modify to a subset of those writeable by the user account in which IE executes. As I described in an <a href="http://blogs.technet.com/markrussinovich/archive/2007/02/12/638372.aspx">earlier blog post</a>, the sandbox defined by locations labeled with Low Integrity, the level at which PMIE executes and of the objects that PMIE can modify, allow PMIE to save favorites and temporary files, like the IE cache and browsing history. However, PMIE cannot modify other locations in a user’s account, like documents folders and per-user autostart locations in the registry and file system, because they have an integrity level of Medium. That prevents drive-by-download malware that might infect the IE process from establishing a persistent presence.
                            </p>
                            <p>
                                In order to preserve backward compatibility with legacy code, such as ActiveX controls and Browser Helper Objects, that might be coded to write to locations outside of the sandbox, PMIE implements <em>shims</em> that intercepts file and registry operations and redirects ones that got outside the sandbox to the Virtualized directory within it.
                            </p>
                            <p>
                                To see if that was what was happening here, I examined the stack trace of the virtualized operation highlighted above by right-clicking on the line and choosing Stack. The stack showed that Acredir.dll was intercepting the operation and executing redirection functions:
                            </p>
                            <p>
                                <a href="http://blogs.technet.com/blogfiles/markrussinovich/WindowsLiveWriter/TheCaseofthePhantomDesktopFiles_4A85/image_22.png"><img style="border-right-width:0px;display:inline;border-top-width:0px;border-bottom-width:0px;border-left-width:0px" title="image" border="0" alt="image" src="http://blogs.technet.com/blogfiles/markrussinovich/WindowsLiveWriter/TheCaseofthePhantomDesktopFiles_4A85/image_thumb_10.png" width="391" height="198"></a>
                            </p>
                            <p>
                                Double-clicking on the line in the stack trace opens the module properties dialog, which shows that the DLL is the “Windows Compatibility DLL”, thus confirming this was part of PMIE’s sandbox implementation:
                            </p>
                            <p>
                                <a href="http://blogs.technet.com/blogfiles/markrussinovich/WindowsLiveWriter/TheCaseofthePhantomDesktopFiles_4A85/image_28.png"><img style="border-right-width:0px;display:inline;border-top-width:0px;border-bottom-width:0px;border-left-width:0px" title="image" border="0" alt="image" src="http://blogs.technet.com/blogfiles/markrussinovich/WindowsLiveWriter/TheCaseofthePhantomDesktopFiles_4A85/image_thumb_13.png" width="244" height="140"></a>
                            </p>
                            <p>
                                I had been familiar with PMIE’s virtualization, but I’d never seen files virtualized on the desktop, so it had not been obvious to me that was what was causing the discrepancy. Process Monitor revealed the cause, so now all I was left with was cleaning up the virtualized files. Most users don’t realize that you can move and delete files from within a file browse dialog, so I took the opportunity to show my wife how she can manage virtualized files from the email editor’s attachment dialog if she came across them again. We deleted the files she didn’t want and moved the pictures out to her photo library folders.
                            </p>
                            <p>
                                The case was closed. As a bonus, my wife was impressed at the ease with which I’d figured out the source of the phantom files and even more impressed that I wrote the tool I used to solve it. She’d also gotten an in depth look at PMIE’s virtualization and integrity levels, but I think in the end my lecturing on those subjects actually subtracted points.
                            </p>
                            <p>
                                Incidentally, you’ll almost certainly see files and directories if you look at the PMIE Virtualized folder in your profile, because even routine operations within IE result in redirection. Here you can see thumbnail cache files that the shell’s file browsing dialog creates when you use it from within IE. Normally, the shell stores thumbnail cache files in your profile, but PMIE can’t write to that location, so the shim virtualizes it: 
                            </p>
                            <p>
                                <a href="http://blogs.technet.com/blogfiles/markrussinovich/WindowsLiveWriter/TheCaseofthePhantomDesktopFiles_4A85/image_20.png"><img style="border-right-width:0px;display:inline;border-top-width:0px;border-bottom-width:0px;border-left-width:0px" title="image" border="0" alt="image" src="http://blogs.technet.com/blogfiles/markrussinovich/WindowsLiveWriter/TheCaseofthePhantomDesktopFiles_4A85/image_thumb_9.png" width="443" height="246"></a>
                            </p><img src="http://blogs.technet.com/aggbug.aspx?PostID=3174194" width="1" height="1">
                        </blockquote>
                    </div>
                    <p class="bookmark-source">
                        Source: <a href="http://blogs.technet.com/markrussinovich/archive/2009/02/03/3174194.aspx">http://blogs.technet.com/markrussinovich/archive/2009/02/03/3174194.aspx</a>
                    </p>
                </div>
            </article>

            <nav id="post-nav">


            </nav>

            <script id="discus-javascript">
                var disqus_shortname = 'improbable';

                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                    document.getElementsByTagName('body')[0].appendChild(dsq);
                })();
            </script>

            <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            <div id="disqus_thread"></div>
        </section>

        <footer id="site-footer" class="nocontent">
            <p>
                This site is purely my personal work and does not reflect the views of my employer.
            </p>
            <p class="license">
                <a class="icon" rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/3.0/88x31.png"></a>
                This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.
            </p>
        </footer>

        <script async src="/static/js/common.js"></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/run_prettify.min.js" integrity="sha256-hj+5FRlAuvAFANiefn0PpJYCkV1X4QT9EgiPd+6QnCw=" crossorigin="anonymous"></script>
    </body>
</html>
