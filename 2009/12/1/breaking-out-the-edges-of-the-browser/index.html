<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Breaking Out The Edges of The Browser</title>
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <link rel="stylesheet" href="/static/css/main.min.css" type="text/css" media="all">
        <!--[if lte IE 8]>
            <link
                rel="stylesheet"
                href="/static/css/ie-fixes.css"
                type="text/css"
                media="all"
            />
            <script src="/static/js/html5shiv.js"></script>
        <![endif]-->

        <meta http-equiv="last-modified" content="Wed, 02 Dec 2009 10:03:08 GMT">
        <link rel="alternate" type="application/atom+xml" title="All Posts (Atom)" href="/feeds/all.atom">
        <link rel="alternate" type="application/rss+xml" title="All Posts (RSS)" href="/feeds/all.rss">
        <link rel="icon" type="image/jpeg" sizes="287x287" href="/static/img/favicon-287x287.jpg">
        <link rel="icon" type="image/jpeg" sizes="128x128" href="/static/img/favicon-128x128.jpg">
    </head>
    <body class="blog post_detail" itemscope itemtype="http://schema.org/BlogPosting">
        <nav id="site-nav">
            <header id="about">
                <h1><a href="/about/">Chris Adams</a></h1>
                <h2>Programmer, cyclist, photographer</h2>
            </header>
            <ul class="links">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about/">About</a>
                </li>
                <li>
                    <a href="/feeds/all.atom" title="Site Feed">Site Feed</a>
                </li>
            </ul>
            <ul class="social-networks">
                <li>
                    <a rel="me" href="https://code4lib.social/@acdha">Mastodon</a>
                </li>
                <li>
                    <a href="https://github.com/acdha" rel="me">Github</a>
                </li>
                <li>
                    <a href="https://bitbucket.org/acdha" rel="me">Bitbucket</a>
                </li>
                <li>
                    <a href="https://pinboard.in/u:acdha/" rel="me">Pinboard</a>
                </li>
                <li>
                    <a href="https://www.flickr.com/photos/acdha" rel="me">Flickr</a>
                </li>
                <li>
                    <a href="https://www.linkedin.com/in/acdha" rel="me">LinkedIn</a>
                </li>
            </ul>
            <div id="site-search"></div>
        </nav>
        <section id="main">
            <article class="post">
                <header>
                    <meta itemprop="dateCreated" content="2009-12-01T19:00:00-04:00">
                    <meta itemprop="dateModified" content="2009-12-01T19:00:00-04:00">
                    <time class="date" itemprop="datePublished" datetime="2009-12-01T23:00:00+00:00">Dec 01</time>
                    <h2 class="" itemprop="title">Breaking Out The Edges of The Browser</h2>
                </header>

                <div class="body" itemprop="articleBody"><div class="googlereader description" data-google-id="tag:google.com,2005:reader/item/6ca497580f34dd79">
                        <blockquote>
                            <p>
                                HTML5 contains more than just the new entities for a more meaningful document, it also contains an arsenal of JavaScript <span>API</span>s. So many in fact, that some <span>API</span>s have outgrown the HTML5 spec’s backyard and have been sent away to grow up all on their own and been given the prestigious honour of being specs in their own right.
                            </p>
                            <p>
                                So when I refer to (bendy finger quote) “HTML5”, I mean the HTML5 specification and a handful of other specifications that help us authors build web applications.
                            </p>
                            <p>
                                Examples of those specs I would include in the umbrella term would be: geolocation, <a href="http://dev.w3.org/html5/webstorage/">web storage</a>, <a href="http://dev.w3.org/html5/webdatabase/">web databases</a>, <a href="http://dev.w3.org/html5/websockets/">web sockets</a> and <a href="http://dev.w3.org/html5/workers/">web workers</a>, to name a few.
                            </p>
                            <p>
                                For all you guys and gals, on this special 2009 series of 24 ways, I’m just going to focus on data storage and offline applications: boldly taking your browser where no browser has gone before!
                            </p>
                            <h3>
                                Web Storage
                            </h3>
                            <p>
                                The Web Storage <span>API</span> is basically cookies on steroids, a unhealthy dosage of steroids. Cookies are always a pain to work with. First of all you have the problem of setting, changing and deleting them. Typically solved by Googling and blindly relying on <a href="http://www.quirksmode.org/js/cookies.html"><span>PPK</span>’s solution</a>. If that wasn’t enough, there’s the 4Kb limit that some of you have hit when you really don’t want to.
                            </p>
                            <p>
                                The Web Storage <span>API</span> gets around all of the hoops you have to jump through with cookies. Storage supports around 5Mb of data per domain (the spec’s recommendation, but it’s open to the browsers to implement anything they like) and splits in to two types of storage objects:
                            </p>
                            <ol>
                                <li>
                                    <code>sessionStorage</code> – available to all pages on that domain while the window remains open
                                </li>
                                <li>
                                    <code>localStorage</code> – available on the domain until manually removed
                                </li>
                            </ol>
                            <h4>
                                Support
                            </h4>
                            <p>
                                Ignoring beta browsers for our support list, below is a list of the major browsers and their support for the Web Storage <span>API</span>:
                            </p>
                            <ul>
                                <li>Latest: Internet Explorer, Firefox, Safari (desktop &amp; mobile/iPhone)
                                </li>
                                <li>Partial: Google Chrome (only supports <code>localStorage</code>)
                                </li>
                                <li>Not supported: Opera (as of 10.10)
                                </li>
                            </ul>
                            <h4>
                                Usage
                            </h4>
                            <p>
                                Both <code>sessionStorage</code> and <code>localStorage</code> support the same interface for accessing their contents, so for these examples I’ll use <code>localStorage</code>.
                            </p>
                            <p>
                                The storage interface includes the following methods:
                            </p>
                            <ul>
                                <li>
                                    <code>setItem(key, value)</code>
                                </li>
                                <li>
                                    <code>getItem(key)</code>
                                </li>
                                <li>
                                    <code>key(index)</code>
                                </li>
                                <li>
                                    <code>removeItem(key)</code>
                                </li>
                                <li>
                                    <code>clear()</code>
                                </li>
                            </ul>
                            <p>
                                In the simple example below, we’ll use <code>setItem</code> and <code>getItem</code> to store and retrieve data:
                            </p>
                            <ol>
                                <li>
                                    <code>localStorage.setItem('name', 'Remy');</code>
                                </li>
                                <li>
                                    <code>alert( localStorage.getItem('name') );</code>
                                </li>
                            </ol>
                            <p>
                                Using <code>alert</code> boxes can be a pretty lame way of debugging. Conveniently Safari (and Chrome) include database tab in their debugging tools (cmd+alt+i), so you can get a visual handle on the state of your data:
                            </p>
                            <p>
                                <img src="http://media.24ways.org/2009/02/localstorage.gif" width="500" height="300" alt="Viewing localStorage"><span>Viewing localStorage</span>
                            </p>
                            <p>
                                As far as I know only Safari has this view on stored data natively in the browser. There <em>may</em> be a Firefox plugin (but I’ve not found it yet!) and IE… well that’s just IE.
                            </p>
                            <p>
                                Even though we’ve used <code>setItem</code> and <code>getItem</code>, there’s also a few other ways you can set and access the data.
                            </p>
                            <p>
                                In the example below, we’re accessing the stored value directly using an <a href="http://en.wiktionary.org/wiki/expando">expando</a> and equally, you can also set values this way:
                            </p>
                            <ol>
                                <li>
                                    <code>localStorage.name = "Remy";</code>
                                </li>
                                <li>
                                    <code>alert( localStorage.name ); // shows "Remy"</code>
                                </li>
                            </ol>
                            <p>
                                The Web Storage <span>API</span> also has a key method, which is zero based, and returns the key in which data has been stored. This should also be in the same order that you set the keys, for example:
                            </p>
                            <ol>
                                <li>
                                    <code>alert( localStorage.getItem(localStorage.key(0)) );</code>
                                </li>
                                <li>
                                    <code>// shows "Remy"</code>
                                </li>
                            </ol>
                            <p>
                                I mention the <code>key()</code> method because it’s not an unlikely name for a stored value. This can cause serious problems though.
                            </p>
                            <p>
                                When selecting the names for your keys, you need to be sure you don’t take one of the method names that are already on the storage object, like <code>key</code>, <code>clear</code>, etc. As there are no warnings when you try to overwrite the methods, it means when you come to access the <code>key()</code> method, the call breaks as key is a string value and not a function.
                            </p>
                            <p>
                                You can try this yourself by creating a new stored value using <code>localStorage.key = "foo"</code> and you’ll see that the Safari debugger breaks because it relies on the <code>key()</code> method to enumerate each of the stored values.
                            </p>
                            <h4>
                                Usage Notes
                            </h4>
                            <p>
                                Currently all browsers only support storing strings. This also means if you store a numeric, it will get converted to a string:
                            </p>
                            <ol>
                                <li>
                                    <code>localStorage.setItem('count', 31);</code>
                                </li>
                                <li>
                                    <code>alert(typeof localStorage.getItem('count'));</code>
                                </li>
                                <li>
                                    <code>// shows "string"</code>
                                </li>
                            </ol>
                            <p>
                                This also means you can’t store more complicated objects natively with the storage objects. To get around this, you can use Douglas Crockford’s <span>JSON</span> parser (though Firefox 3.5 has <span>JSON</span> parsing support baked in to the browser – yay!) <a href="http://www.json.org/json2.js" title="JSON in JavaScript">json2.js</a> to convert the object to a stringified <span>JSON</span> object:
                            </p>
                            <ol>
                                <li>
                                    <code>var person = {</code>
                                </li>
                                <li>
                                    <code>name: 'Remy',</code>
                                </li>
                                <li>
                                    <code>height: 'short',</code>
                                </li>
                                <li>
                                    <code>location: 'Brighton, UK'</code>
                                </li>
                                <li>
                                    <code>};</code>
                                </li>
                                <li> 
                                </li>
                                <li>
                                    <code>localStorage.setItem('person', JSON.stringify(person));</code>
                                </li>
                                <li>
                                    <code>alert( JSON.parse(localStorage.getItem('person')).name );</code>
                                </li>
                                <li>
                                    <code>// shows "Remy"</code>
                                </li>
                            </ol>
                            <h4>
                                Alternatives
                            </h4>
                            <p>
                                There are a few solutions out there that provide storage solutions that detect the Web Storage <span>API</span>, and if it’s not available, fall back to different technologies (for instance, using a flash object to store data). One comprehensive version of this is <a href="http://docs.dojocampus.org/dojox/storage">Dojo’s storage library</a>. I’m personally more of a fan of libraries that plug missing functionality under the same namespace, just as Crockford’s <span>JSON</span> parser does (above).
                            </p>
                            <p>
                                For those interested it what that might look like, I’ve mocked together a simple implementation of <code>sessionStorage</code>. Note that it’s incomplete (because it’s missing the <code>key</code> method), and it could be refactored to not using the <span>JSON</span> stringify (but you would need to ensure that the values were properly and safely encoded):
                            </p>
                            <ol>
                                <li>
                                    <code>// requires json2.js for all browsers other than Firefox 3.5</code>
                                </li>
                                <li>
                                    <code>if (!window.sessionStorage &amp;&amp; JSON) {</code>
                                </li>
                                <li>
                                    <code>window.sessionStorage = (function () {</code>
                                </li>
                                <li>
                                    <code>// window.top.name ensures top level, and supports around 2Mb</code>
                                </li>
                                <li>
                                    <code>var data = window.top.name ? JSON.parse(window.top.name) : {};</code>
                                </li>
                                <li>
                                    <code>return {</code>
                                </li>
                                <li>
                                    <code>setItem: function (key, value) {</code>
                                </li>
                                <li>
                                    <code>data[key] = value+""; // force to string</code>
                                </li>
                                <li>
                                    <code>window.top.name = JSON.stringify(data);</code>
                                </li>
                                <li>
                                    <code>},</code>
                                </li>
                                <li>
                                    <code>removeItem: function (key) {</code>
                                </li>
                                <li>
                                    <code>delete data[key];</code>
                                </li>
                                <li>
                                    <code>window.top.name = JSON.stringify(data);</code>
                                </li>
                                <li>
                                    <code>},</code>
                                </li>
                                <li>
                                    <code>getItem: function (key) {</code>
                                </li>
                                <li>
                                    <code>return data[key] || null;</code>
                                </li>
                                <li>
                                    <code>},</code>
                                </li>
                                <li>
                                    <code>clear: function () {</code>
                                </li>
                                <li>
                                    <code>data = {};</code>
                                </li>
                                <li>
                                    <code>window.top.name = '';</code>
                                </li>
                                <li>
                                    <code>}</code>
                                </li>
                                <li>
                                    <code>};</code>
                                </li>
                                <li>
                                    <code>})();</code>
                                </li>
                                <li>
                                    <code>}</code>
                                </li>
                                <li>Source: <a href="http://24ways.org/code/breaking-out-the-edges-of-the-browser/7.txt" title="Download the above code as a textfile">/code/breaking-out-the-edges-of-the-browser/7.txt</a>
                                </li>
                            </ol>
                            <p>
                                Now that we’ve cracked the cookie jar with our oversized Web Storage <span>API</span>, let’s have a look at how we take our applications offline entirely.
                            </p>
                            <h3>
                                Offline Applications
                            </h3>
                            <p>
                                Offline applications is (still) part of the HTML5 specification. It allows developers to build a web app and have it still function without an internet connection. The app is access via the same <span>URL</span> as it would be if the user were online, but the contents (or what the developer specifies) is served up to the browser from a local cache. From there it’s just an everyday stroll through open web technologies, i.e. you still have access to the Web Storage <span>API</span> and anything else you can do without a web connection.
                            </p>
                            <p>
                                For this section, I’ll refer you to a prototype demo I wrote recently of a <strong>contrived</strong> <a href="http://remysharp.com/demo/rubiks/">Rubik’s cube</a> (contrived because it doesn’t work and it only works in Safari because I’m using 3D transforms).
                            </p>
                            <p>
                                <img src="http://media.24ways.org/2009/02/rubiks.png" width="320" height="480" alt="Offline Rubik's cube"><span>Offline Rubik’s cube</span>
                            </p>
                            <h4>
                                Support
                            </h4>
                            <p>
                                Support for offline applications is still fairly limited, but the possibilities of offline applications is pretty exciting, particularly as we’re seeing mobile support and support in applications such as Fluid (and I would expect other render engine wrapping apps).
                            </p>
                            <p>
                                Support currently, is as follows:
                            </p>
                            <ul>
                                <li>Latest: Safari (desktop &amp; mobile/iPhone)
                                </li>
                                <li>Sort of: Firefox<sup>‡</sup>
                                </li>
                                <li>Not supported: Internet Explorer, Opera, Google Chrome
                                </li>
                            </ul>
                            <p>
                                ‡ Firefox 3.5 was released to include offline support, but in fact has bugs where it doesn’t work properly (certainly on the Mac), Minefield (Firefox beta) has resolved the bug.
                            </p>
                            <h4>
                                Usage
                            </h4>
                            <p>
                                The status of the application’s cache can be tested from the <code>window.applicationCache</code> object. However, we’ll first look at how to enable your app for offline access.
                            </p>
                            <p>
                                You need to create a manifest file, which will tell the browser what to cache, and then we point our web page to that cache:
                            </p>
                            <ol>
                                <li>
                                    <code>&lt;!DOCTYPE html&gt;</code>
                                </li>
                                <li>
                                    <code>&lt;html manifest="remy.manifest"&gt;</code>
                                </li>
                                <li>
                                    <code>&lt;!-- continues ... --&gt;</code>
                                </li>
                            </ol>
                            <p>
                                For the manifest to be properly read by the browser, your server needs to serve the .manifest files as <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/iana.html#text/cache-manifest"><code>text/manifest</code></a> by adding the following to your <code>mime.types</code>:
                            </p>
                            <ol>
                                <li>
                                    <code>text/cache-manifest manifest</code>
                                </li>
                            </ol>
                            <p>
                                Next we need to populate <a href="http://remysharp.com/demo/rubiks/rubik.manifest">our manifest file</a> so the browser can read it:
                            </p>
                            <ol>
                                <li>
                                    <code>CACHE MANIFEST</code>
                                </li>
                                <li>
                                    <code>/demo/rubiks/index.html</code>
                                </li>
                                <li>
                                    <code>/demo/rubiks/style.css</code>
                                </li>
                                <li>
                                    <code>/demo/rubiks/jquery.min.js</code>
                                </li>
                                <li>
                                    <code>/demo/rubiks/rubiks.js</code>
                                </li>
                                <li> 
                                </li>
                                <li>
                                    <code># version 15</code>
                                </li>
                            </ol>
                            <p>
                                The first line of the manifest must read <code>CACHE MANIFEST</code>. Then subsequent lines tell the browser what to cache.
                            </p>
                            <p>
                                The HTML5 spec recommends that you include the calling web page (in my case <code>index.html</code>), but it’s not required. If I didn’t include <code>index.html</code>, the browser would cache it as part of the offline resources.
                            </p>
                            <p>
                                These resources are implicitly under the <code>CACHE</code> namespace (which you can specify any number of times if you want to).
                            </p>
                            <p>
                                In addition, there are two further namespaces: <code>NETWORK</code> and <code>FALLBACK</code>.
                            </p>
                            <p>
                                <code>NETWORK</code> is a whitelist namespace that tells the browser not to cache this resource and always try to request it through the network.
                            </p>
                            <p>
                                <code>FALLBACK</code> tells the browser that whilst in offline mode, if the resource isn’t available, it should return the fallback resource.
                            </p>
                            <p>
                                Finally, in my example I’ve included a comment with a version number. This is because once you include a manifest, the <strong>only</strong> way you can tell the browser to reload the resources is if the manifest contents changes. So I’ve included a version number in the manifest which I can change forcing the browser to reload all of the assets.
                            </p>
                            <h4>
                                How it works
                            </h4>
                            <p>
                                If you’re building an app that makes use of the offline cache, I would strongly recommend that you add the manifest last. The browser implementations are very new, so can sometimes get a bit tricky to debug since once the resources are cached, they <strong>really</strong> stick in the browser.
                            </p>
                            <p>
                                These are the steps that happen during a request for an app with a manifest:
                            </p>
                            <ol>
                                <li>Browser: sends request for your app.html
                                </li>
                                <li>Server: serves all associated resources with app.html – as normal
                                </li>
                                <li>Browser: notices that app.html has a manifest, it re-request the assets in the manifest
                                </li>
                                <li>Server: serves the requested manifest assets (again)
                                </li>
                                <li>Browser: window.applicationCache has a status of <code>UPDATEREADY</code>
                                </li>
                                <li>Browser: reloads
                                </li>
                                <li>Browser: only request manifest file (which doesn’t show on the net requests panel)
                                </li>
                                <li>Server: responds with 304 Not Modified on the manifest file
                                </li>
                                <li>Browser: serves all the cached resources locally
                                </li>
                            </ol>
                            <p>
                                What might also add confusion to this process, is that the way the browsers work (currently) is if there is a cache already in place, it will use this first over updated resources. So if your manifest has changed, the browser will have already loaded the offline cache, so the user will only see the updated on the next reload.
                            </p>
                            <p>
                                This may seem a bit convoluted, but you can also trigger some of this manually through the <code>applicationCache</code> methods which can ease some of this pain.
                            </p>
                            <p>
                                If you bind to the <code>online</code> event you can manually try to update the offline cache. If the cache has then updated, swap the updated resources in to the cache and the next time the app loads it will be up to date. You could also prompt your user to reload the app (which is just a refresh) if there’s an update available.
                            </p>
                            <p>
                                For example (though this is <strong>just</strong> pseudo code):
                            </p>
                            <ol>
                                <li>
                                    <code>addEvent(applicationCache, 'updateready', function () {</code>
                                </li>
                                <li>
                                    <code>applicationCache.swapCache();</code>
                                </li>
                                <li>
                                    <code>tellUserToRefresh();</code>
                                </li>
                                <li>
                                    <code>});</code>
                                </li>
                                <li> 
                                </li>
                                <li>
                                    <code>addEvent(window, 'online', function () {</code>
                                </li>
                                <li>
                                    <code>applicationCache.update();</code>
                                </li>
                                <li>
                                    <code>});</code>
                                </li>
                            </ol>
                            <h3>
                                Breaking out of the Browser
                            </h3>
                            <p>
                                So that’s two different technologies that you can use to break out of the traditional browser/web page model and get your apps working in a more <strong>application-ny way</strong>.
                            </p>
                            <p>
                                There’s loads more in the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/">HTML5</a> and <a href="http://dev.w3.org/html5/">non-HTML5 <span>API</span>s</a> to play with, so take your Christmas break to check them out!
                            </p>
                            <div>
                                <a href="http://feeds.feedburner.com/~ff/24ways?a=HOpPhlWjgNw:axtCk93e6hA:yIl2AUoC8zA"><img src="http://feeds.feedburner.com/~ff/24ways?d=yIl2AUoC8zA" border="0"></a> <a href="http://feeds.feedburner.com/~ff/24ways?a=HOpPhlWjgNw:axtCk93e6hA:7Q72WNTAKBA"><img src="http://feeds.feedburner.com/~ff/24ways?d=7Q72WNTAKBA" border="0"></a> <a href="http://feeds.feedburner.com/~ff/24ways?a=HOpPhlWjgNw:axtCk93e6hA:V_sGLiPBpWU"><img src="http://feeds.feedburner.com/~ff/24ways?i=HOpPhlWjgNw:axtCk93e6hA:V_sGLiPBpWU" border="0"></a> <a href="http://feeds.feedburner.com/~ff/24ways?a=HOpPhlWjgNw:axtCk93e6hA:dnMXMwOfBR0"><img src="http://feeds.feedburner.com/~ff/24ways?d=dnMXMwOfBR0" border="0"></a>
                            </div>
                        </blockquote>
                    </div>
                    <p class="bookmark-source">
                        Source: <a href="http://24ways.org/2009/breaking-out-the-edges-of-the-browser">http://24ways.org/2009/breaking-out-the-edges-of-the-browser</a>
                    </p>
                </div>
            </article>

            <nav id="post-nav">


            </nav>
        </section>

        <footer id="site-footer" class="nocontent">
            <p>
                This site is purely my personal work and does not reflect the
                views of my employer.
            </p>
            <p class="license">
                <a class="icon" rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width: 0" src="https://i.creativecommons.org/l/by-sa/3.0/88x31.png"></a>
                This work is licensed under a
                <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative Commons Attribution-ShareAlike 3.0 Unported
                    License</a>.
            </p>
        </footer>

        <script async src="/static/js/common.js"></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/run_prettify.min.js" integrity="sha256-hj+5FRlAuvAFANiefn0PpJYCkV1X4QT9EgiPd+6QnCw=" crossorigin="anonymous"></script>
    </body>
</html>
