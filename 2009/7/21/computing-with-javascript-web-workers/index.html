<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Computing with JavaScript Web Workers</title>
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <link rel="stylesheet" href="/static/css/main.min.css" type="text/css" media="all">
        <!--[if lte IE 8]>
            <link
                rel="stylesheet"
                href="/static/css/ie-fixes.css"
                type="text/css"
                media="all"
            />
            <script src="/static/js/html5shiv.js"></script>
        <![endif]-->

        <meta http-equiv="last-modified" content="Tue, 21 Jul 2009 20:25:32 GMT">
        <link rel="alternate" type="application/atom+xml" title="All Posts (Atom)" href="/feeds/all.atom">
        <link rel="alternate" type="application/rss+xml" title="All Posts (RSS)" href="/feeds/all.rss">
        <link rel="icon" type="image/jpeg" sizes="287x287" href="/static/img/favicon-287x287.jpg">
        <link rel="icon" type="image/jpeg" sizes="128x128" href="/static/img/favicon-128x128.jpg">
    </head>
    <body class="blog post_detail" itemscope itemtype="http://schema.org/BlogPosting">
        <nav id="site-nav">
            <header id="about">
                <h1><a href="/about/">Chris Adams</a></h1>
                <h2>Programmer, cyclist, photographer</h2>
            </header>
            <ul class="links">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about/">About</a>
                </li>
                <li>
                    <a href="/feeds/all.atom" title="Site Feed">Site Feed</a>
                </li>
            </ul>
            <ul class="social-networks">
                <li>
                    <a rel="me" href="https://code4lib.social/@acdha">Mastodon</a>
                </li>
                <li>
                    <a href="https://github.com/acdha" rel="me">Github</a>
                </li>
                <li>
                    <a href="https://bitbucket.org/acdha" rel="me">Bitbucket</a>
                </li>
                <li>
                    <a href="https://pinboard.in/u:acdha/" rel="me">Pinboard</a>
                </li>
                <li>
                    <a href="https://www.flickr.com/photos/acdha" rel="me">Flickr</a>
                </li>
                <li>
                    <a href="https://www.linkedin.com/in/acdha" rel="me">LinkedIn</a>
                </li>
            </ul>
            <div id="site-search"></div>
        </nav>
        <section id="main">
            <article class="post">
                <header>
                    <meta itemprop="dateCreated" content="2009-07-21T16:25:32-04:00">
                    <meta itemprop="dateModified" content="2009-07-21T16:25:32-04:00">
                    <time class="date" itemprop="datePublished" datetime="2009-07-21T20:25:32+00:00">Jul 21</time>
                    <h2 class="" itemprop="title">Computing with JavaScript Web Workers</h2>
                </header>

                <div class="body" itemprop="articleBody"><div class="googlereader description" data-google-id="tag:google.com,2005:reader/item/30e5b4960f7d1a37">
                        <blockquote>
                            <p>
                                <a href="http://www.whatwg.org/specs/web-workers/current-work/">Web Workers</a> are, undoubtedly, the coolest new feature to arrive in the latest version of web browsers. Web Workers allow you to run JavaScript in parallel on a web page, without blocking the user interface.
                            </p>
                            <p>
                                Normally in order to achieve any sort of computation using JavaScript you would need to break your jobs up into tiny chunks and split their execution apart using timers. This is both slow and unimpressive (since you can't actually run anything in parallel - more information on this in <a href="http://ejohn.org/blog/how-javascript-timers-work/">How JavaScript Timers Work</a>).
                            </p>
                            <p>
                                With our current situation in mind, let's dig in to Web Workers.
                            </p>
                            <h3>
                                Web Workers
                            </h3>
                            <p>
                                The <a href="http://www.whatwg.org/specs/web-workers/current-work/">Web Worker recommendation</a> is partially based off of the prior work done by the Gears team on their <a href="http://code.google.com/apis/gears/api_workerpool.html">WorkerPool Module</a>. The idea has since grown and been tweaked to become a full recommendation.
                            </p>
                            <p>
                                A 'worker' is a script that will be loaded and executed in the background. Web Workers provide a way to do this seamlessly, for example:
                            </p>
                            <div>
                                <div>
                                    <div>
                                        <span style="color:#003366;font-weight:bold">new</span> Worker<span style="color:#008800;font-weight:bold">(</span><span style="color:#3366CC">"worker.js"</span><span style="color:#008800;font-weight:bold">)</span>;
                                    </div>
                                </div>
                            </div>
                            <p>
                                The above will load the script, located at 'worker.js', and execute it in the background.
                            </p>
                            <p>
                                There are some HUGE stipulations, though:
                            </p>
                            <ol>
                                <li>Workers don't have access to the DOM. No <code>document</code>, <code>getElementById</code>, etc. (The notable exceptions are <code>setTimeout</code>, <code>setInterval</code>, and <code>XMLHttpRequest</code>.)
                                </li>
                                <li>Workers don't have direct access to the 'parent' page.
                                </li>
                            </ol>
                            <p>
                                With these points in mind the big question should be: How do you actually use a worker and what is it useful for?
                            </p>
                            <p>
                                You use a worker by communicating with it using messages. All browsers support passing in a string message (Firefox 3.5 also supports passing in JSON-compatible objects). This message will be communicated to the worker (the worker can also communicate messages back to the parent page). This is the extent to which communication can occur.
                            </p>
                            <p>
                                The message passing is done using the <a href="http://ejohn.org/blog/postmessage-api-changes/">postMessage</a> API, working like this:
                            </p>
                            <div>
                                <div>
                                    <div>
                                        <span style="color:#003366;font-weight:bold">var</span> worker = <span style="color:#003366;font-weight:bold">new</span> Worker<span style="color:#008800;font-weight:bold">(</span><span style="color:#3366CC">"worker.js"</span><span style="color:#008800;font-weight:bold">)</span>;
                                        <p>
                                            <span style="color:#009900;font-style:italic">// Watch for messages from the worker</span><br>
                                            worker.<span style="color:#006600">onmessage</span> = <span style="color:#003366;font-weight:bold">function</span><span style="color:#008800;font-weight:bold">(</span>e<span style="color:#008800;font-weight:bold">)</span><span style="color:#008800;font-weight:bold">{</span><br>
                                              <span style="color:#009900;font-style:italic">// The message from the client:</span><br>
                                              e.<span style="color:#006600">data</span><br>
                                            <span style="color:#008800;font-weight:bold">}</span>;
                                        </p>
                                        <p>
                                            worker.<span style="color:#006600">postMessage</span><span style="color:#008800;font-weight:bold">(</span><span style="color:#3366CC">"start"</span><span style="color:#008800;font-weight:bold">)</span>;
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <p>
                                <strong>The Client:</strong>
                            </p>
                            <div>
                                <div>
                                    <div>
                                        onmessage = <span style="color:#003366;font-weight:bold">function</span><span style="color:#008800;font-weight:bold">(</span>e<span style="color:#008800;font-weight:bold">)</span><span style="color:#008800;font-weight:bold">{</span><br>
                                          <span style="color:#000066;font-weight:bold">if</span> <span style="color:#008800;font-weight:bold">(</span> e.<span style="color:#006600">data</span> === <span style="color:#3366CC">"start"</span> <span style="color:#008800;font-weight:bold">)</span> <span style="color:#008800;font-weight:bold">{</span><br>
                                            <span style="color:#009900;font-style:italic">// Do some computation</span><br>
                                            done<span style="color:#008800;font-weight:bold">(</span><span style="color:#008800;font-weight:bold">)</span><br>
                                          <span style="color:#008800;font-weight:bold">}</span><br>
                                        <span style="color:#008800;font-weight:bold">}</span>;
                                        <p>
                                            <span style="color:#003366;font-weight:bold">function</span> done<span style="color:#008800;font-weight:bold">(</span><span style="color:#008800;font-weight:bold">)</span><span style="color:#008800;font-weight:bold">{</span><br>
                                              <span style="color:#009900;font-style:italic">// Send back the results to the parent page</span><br>
                                              postMessage<span style="color:#008800;font-weight:bold">(</span><span style="color:#3366CC">"done"</span><span style="color:#008800;font-weight:bold">)</span>;<br>
                                            <span style="color:#008800;font-weight:bold">}</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <p>
                                This particular message-passing limitation is in place for a number of reasons: It keeps the child worker running securely (since it can't, blatantly, affect a parent script) and it keeps the parent page thread-safe (having the DOM be thread safe would be a logistical nightmare for browser developers).
                            </p>
                            <p>
                                Right now Web Workers are implemented by Firefox 3.5 and Safari 4. They've also landed in the <a href="http://build.chromium.org/buildbot/snapshots/chromium-rel-xp/">latest Chromium nightlies</a>. Most people would balk when hearing this (only two released browsers!) but this shouldn't be a concern. Workers allow you to take a normal piece of computation and highly parallelize it. In this way you can easily have two versions of a script (one that runs in older browsers and one that runs in a worker, if it's available). Newer browsers will just run that much faster.
                            </p>
                            <p>
                                Some interesting demos have already been created that utilize this new API.
                            </p>
                            <p>
                                <strong>RayTracing</strong>
                            </p>
                            <p>
                                <a href="http://nerget.com/rayjs-mt/rayjs.html"><img src="http://ejohn.org/files/ww-raytracer.sm.png"></a>
                            </p>
                            <p>
                                This demo makes use of Canvas to draw out a rendered scene. You'll note that when you turn on the workers the scene is drawn in pieces. This is working by telling a worker to compute a slice of pixels. The worker responds with an array of colors to draw on the Canvas and the parent page changes the canvas. (Note that the worker itself doesn't manipulate the canvas.)
                            </p>
                            <p>
                                <strong>Movement Tracking</strong>
                            </p>
                            <p>
                                <a href="http://www.mozbox.org/pub/tracker/"><img src="http://ejohn.org/files/ww-move.sm.png"></a>
                            </p>
                            <p>
                                (Requires Firefox 3.5. <a href="http://blog.mozbox.org/post/2009/02/20/Video-Canvas-Worker-thread-A-movement-tracker">About the demo</a>.) This one uses a number of technologies: The video element, the canvas element, and drawing video frames to a canvas. All of the motion detection it taking place in the background worker (so that the video rendering isn't blocked).
                            </p>
                            <p>
                                <strong>Simulated Annealing</strong>
                            </p>
                            <p>
                                <a href="http://www.mozbox.org/pub/simulatedAnnealing/"><img src="http://ejohn.org/files/ww-anneal.sm.png"></a>
                            </p>
                            <p>
                                This demo attempts to draw outlines around a series of randomly-placed points using simulated annealing (<a href="http://en.wikipedia.org/wiki/Simulated_annealing">More information</a>). It also includes an animated PNG (works in Firefox 3.5) that continues to spin even while all the processing is occurring in the background.
                            </p>
                            <h3>
                                Computing with JavaScript Web Workers
                            </h3>
                            <p>
                                The other day Engine Yard started <a href="http://www.engineyard.com/blog/2009/programming-contest-win-iphone-3gs-2k-cloud-credit/">an interesting contest</a> (which is probably over, by the time that you're reading this).
                            </p>
                            <p>
                                The premise is that they would give you a phrase, which you would take the SHA1 of, and try to find another SHA1-ed string that has the smallest possible <a href="http://en.wikipedia.org/wiki/Hamming_distance">hamming distance</a> from the original.
                            </p>
                            <p>
                                The phrase was <a href="http://www.engineyard.com/blog/2009/engine-yard-contest-challenge-phrase-and-dictionary/">posted the other day</a> and developers have been furiously working to find a string that yields a low value.
                            </p>
                            <p>
                                The current leader is using a series of <a href="http://forums.nvidia.com/index.php?showtopic=102349">dedicated GPUs</a> crunching out results at a pace of a couple hundred million per second. Considering the rate at which they're progressing any other implementation will have a hard time catching up.
                            </p>
                            <p>
                                Of greater interest to me were two pure-JavaScript (<a href="http://www.raycmorgan.com/">1</a>, <a href="http://rustyengines.silentmac.com/jsengine.php">2</a>) entrants into the competition - they both run completely in the browser and utilize the user's JavaScript engine to find results. While neither of them have a prayer of overcoming the GPU-powered monsters dominating the pack, they do serve as an interesting realm for exploration.
                            </p>
                            <p>
                                Reading through the source to both implementations they both utilize nearly-identical tactics for computing results: They execute a batch of results broken up by a timer. I've played around with them in different browsers and have been able to get around 1000-1500 matches/second. Unfortunately they both peg the CPU pretty hard and even with the timer splitting they manage to bog down the user interface.
                            </p>
                            <p>
                                This sounds like a perfect opportunity to use Web Workers!
                            </p>
                            <p>
                                I took the <a href="http://www.raycmorgan.com/">Ray C Morgan implementation</a>, stripped out all the UI components and timers, and pushed it in to worker (through which 4 of them are run in parallel). (I submit results back to the original implementation, just in case a good result is found.)
                            </p>
                            <p>
                                Check out the demo and source:
                            </p>
                            <ul>
                                <li>
                                    <a href="http://ejohn.org/apps/web-workers/">SHA1-Crunching Web Worker Demo</a>
                                </li>
                                <li>
                                    <a href="http://ejohn.org/apps/web-workers/run.js">'Parent' Source</a>
                                </li>
                                <li>
                                    <a href="http://ejohn.org/apps/web-workers/worker.js">Worker Source</a>
                                </li>
                            </ul>
                            <p>
                                I ran the <a href="http://www.raycmorgan.com/">old implementation</a> against the new one in the browsers that support Web Workers to arrive at the following results:
                            </p>
                            <table style="font-family:Helvetica,Arial;font-size:10px;width:400px">
                                <tr>
                                    <th>
                                        Browser
                                    </th>
                                    <th>
                                        Old Runs/s
                                    </th>
                                    <th>
                                        New Runs/s
                                    </th>
                                </tr>
                                <tr>
                                    <th>
                                        Firefox 3.5
                                    </th>
                                    <td>
                                        2700
                                    </td>
                                    <td>
                                        4600
                                    </td>
                                </tr>
                                <tr>
                                    <th>
                                        Safari 4
                                    </th>
                                    <td>
                                        2500
                                    </td>
                                    <td>
                                        8400
                                    </td>
                                </tr>
                                <tr>
                                    <th>
                                        Chrome Nightly
                                    </th>
                                    <td>
                                        4500
                                    </td>
                                    <td>
                                        9600
                                    </td>
                                </tr>
                            </table>
                            <p>
                                How does this implementation work? Digging in to the <a href="http://ejohn.org/apps/web-workers/run.js">source of the parent launcher</a> we can see:
                            </p>
                            <div>
                                <div>
                                    <div>
                                        <span style="color:#009900;font-style:italic">// Build a worker</span><br>
                                        <span style="color:#003366;font-weight:bold">var</span> worker = <span style="color:#003366;font-weight:bold">new</span> Worker<span style="color:#008800;font-weight:bold">(</span><span style="color:#3366CC">"worker.js"</span><span style="color:#008800;font-weight:bold">)</span>;
                                        <p>
                                            <span style="color:#009900;font-style:italic">// Listen for incoming messages</span><br>
                                            worker.<span style="color:#006600">onmessage</span> = <span style="color:#003366;font-weight:bold">function</span><span style="color:#008800;font-weight:bold">(</span>e<span style="color:#008800;font-weight:bold">)</span><span style="color:#008800;font-weight:bold">{</span><br>
                                              <span style="color:#003366;font-weight:bold">var</span> parts = e.<span style="color:#006600">data</span>.<span style="color:#006600">split</span><span style="color:#008800;font-weight:bold">(</span><span style="color:#3366CC">" "</span><span style="color:#008800;font-weight:bold">)</span>;<br>
                                             <br>
                                              <span style="color:#009900;font-style:italic">// We're getting the rate at which computations are done</span><br>
                                              <span style="color:#000066;font-weight:bold">if</span> <span style="color:#008800;font-weight:bold">(</span> parts<span style="color:#008800;font-weight:bold">[</span><span style="color:#CC0000">0</span><span style="color:#008800;font-weight:bold">]</span> === <span style="color:#3366CC">"rate"</span> <span style="color:#008800;font-weight:bold">)</span> <span style="color:#008800;font-weight:bold">{</span><br>
                                                rates<span style="color:#008800;font-weight:bold">[</span>i<span style="color:#008800;font-weight:bold">]</span> = parseInt<span style="color:#008800;font-weight:bold">(</span>parts<span style="color:#008800;font-weight:bold">[</span><span style="color:#CC0000">1</span><span style="color:#008800;font-weight:bold">]</span><span style="color:#008800;font-weight:bold">)</span>;<br>
                                             <br>
                                                <span style="color:#009900;font-style:italic">// Total the rates from all the workers</span><br>
                                                <span style="color:#003366;font-weight:bold">var</span> total = <span style="color:#CC0000">0</span>;   <br>
                                                <span style="color:#000066;font-weight:bold">for</span> <span style="color:#008800;font-weight:bold">(</span> <span style="color:#003366;font-weight:bold">var</span> j = <span style="color:#CC0000">0</span>; j &lt; rates.<span style="color:#006600">length</span>; j++ <span style="color:#008800;font-weight:bold">)</span> <span style="color:#008800;font-weight:bold">{</span><br>
                                                  total += rates<span style="color:#008800;font-weight:bold">[</span>j<span style="color:#008800;font-weight:bold">]</span>;     <br>
                                                <span style="color:#008800;font-weight:bold">}</span>                 <br>
                                                num.<span style="color:#006600">innerHTML</span> = total;<br>
                                             <br>
                                              <span style="color:#009900;font-style:italic">// We've found a new best score, send it to the server</span><br>
                                              <span style="color:#008800;font-weight:bold">}</span> <span style="color:#000066;font-weight:bold">else</span> <span style="color:#000066;font-weight:bold">if</span> <span style="color:#008800;font-weight:bold">(</span> parts<span style="color:#008800;font-weight:bold">[</span><span style="color:#CC0000">0</span><span style="color:#008800;font-weight:bold">]</span> === <span style="color:#3366CC">"found"</span> <span style="color:#008800;font-weight:bold">)</span> <span style="color:#008800;font-weight:bold">{</span><br>
                                                <span style="color:#003366;font-weight:bold">var</span> img = document.<span style="color:#006600">createElement</span><span style="color:#008800;font-weight:bold">(</span><span style="color:#3366CC">"img"</span><span style="color:#008800;font-weight:bold">)</span>;<br>
                                                img.<span style="color:#006600">src</span> = <span style="color:#3366CC">"http://www.raycmorgan.com/new-best?phrase="</span> +<br>
                                                  escape<span style="color:#008800;font-weight:bold">(</span>parts.<span style="color:#006600">slice</span><span style="color:#008800;font-weight:bold">(</span><span style="color:#CC0000">1</span><span style="color:#008800;font-weight:bold">)</span>.<span style="color:#006600">join</span><span style="color:#008800;font-weight:bold">(</span><span style="color:#3366CC">" "</span><span style="color:#008800;font-weight:bold">)</span><span style="color:#008800;font-weight:bold">)</span>;       <br>
                                                document.<span style="color:#006600">body</span>.<span style="color:#006600">appendChild</span><span style="color:#008800;font-weight:bold">(</span> img <span style="color:#008800;font-weight:bold">)</span>;<br>
                                             <br>
                                              <span style="color:#009900;font-style:italic">// A new personal best score was found</span><br>
                                              <span style="color:#008800;font-weight:bold">}</span> <span style="color:#000066;font-weight:bold">else</span> <span style="color:#000066;font-weight:bold">if</span> <span style="color:#008800;font-weight:bold">(</span> parts<span style="color:#008800;font-weight:bold">[</span><span style="color:#CC0000">0</span><span style="color:#008800;font-weight:bold">]</span> === <span style="color:#3366CC">"mybest"</span> <span style="color:#008800;font-weight:bold">)</span> <span style="color:#008800;font-weight:bold">{</span><br>
                                                <span style="color:#003366;font-weight:bold">var</span> tmp = parseInt<span style="color:#008800;font-weight:bold">(</span>parts<span style="color:#008800;font-weight:bold">[</span><span style="color:#CC0000">1</span><span style="color:#008800;font-weight:bold">]</span><span style="color:#008800;font-weight:bold">)</span>;<br>
                                                <span style="color:#000066;font-weight:bold">if</span> <span style="color:#008800;font-weight:bold">(</span> tmp &lt; mybest <span style="color:#008800;font-weight:bold">)</span> <span style="color:#008800;font-weight:bold">{</span><br>
                                                  mybest = tmp;           <br>
                                                  best.<span style="color:#006600">innerHTML</span> = mybest;<br>
                                                <span style="color:#008800;font-weight:bold">}</span>                 <br>
                                              <span style="color:#008800;font-weight:bold">}</span>           <br>
                                            <span style="color:#008800;font-weight:bold">}</span>;   
                                        </p>
                                        <p>
                                            <span style="color:#009900;font-style:italic">// Start the worker</span><br>
                                            worker.<span style="color:#006600">postMessage</span><span style="color:#008800;font-weight:bold">(</span> data.<span style="color:#006600">sha</span> + <span style="color:#3366CC">" "</span> +<br>
                                              data.<span style="color:#006600">words</span>.<span style="color:#006600">join</span><span style="color:#008800;font-weight:bold">(</span><span style="color:#3366CC">","</span><span style="color:#008800;font-weight:bold">)</span> + <span style="color:#3366CC">" "</span> + data.<span style="color:#006600">best</span> <span style="color:#008800;font-weight:bold">)</span>;
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <p>
                                To start, we're constructing the worker and listening for any incoming messages. There are three types of messages that can come from the worker: "rate" (a 'ping' from the worker notifying the parent how quickly it's running), "found" (sent back when a new high scoring phrase has been found by the client), and "mybest" (sent when the worker gets a new personal-best high score).
                            </p>
                            <p>
                                Additionally we can see the initialization data sent to the client in <code>worker.postMessage</code>. Unfortunately we have to pass the data in using a string in order to have it work in all browsers (only Firefox 3.5 supports the ability to pass in a raw JavaScript object).
                            </p>
                            <p>
                                Looking at the contents of the <a href="http://ejohn.org/apps/web-workers/worker.js">worker</a> we can see some more, interesting, logic.
                            </p>
                            <div>
                                <div>
                                    <div>
                                        <span style="color:#009900;font-style:italic">// ... snip ...</span>
                                        <p>
                                            <span style="color:#009900;font-style:italic">// New Personal Best Found</span><br>
                                            <span style="color:#000066;font-weight:bold">if</span> <span style="color:#008800;font-weight:bold">(</span>distance &lt; myBest<span style="color:#008800;font-weight:bold">)</span> <span style="color:#008800;font-weight:bold">{</span><br>
                                              myBest = distance;<br>
                                              postMessage<span style="color:#008800;font-weight:bold">(</span><span style="color:#3366CC">"mybest "</span> + myBest<span style="color:#008800;font-weight:bold">)</span>;<br>
                                            <span style="color:#008800;font-weight:bold">}</span>
                                        </p>
                                        <p>
                                            <span style="color:#009900;font-style:italic">// New All-time Best Found</span><br>
                                            <span style="color:#000066;font-weight:bold">if</span> <span style="color:#008800;font-weight:bold">(</span>distance &lt; best<span style="color:#008800;font-weight:bold">)</span> <span style="color:#008800;font-weight:bold">{</span><br>
                                              best = distance;<br>
                                              postMessage<span style="color:#008800;font-weight:bold">(</span><span style="color:#3366CC">"found "</span> + phrase<span style="color:#008800;font-weight:bold">)</span>;<br>
                                            <span style="color:#008800;font-weight:bold">}</span>
                                        </p>
                                        <p>
                                            <span style="color:#009900;font-style:italic">// ... snip ...</span>
                                        </p>
                                        <p>
                                            <span style="color:#009900;font-style:italic">// Report Rate Back to Parent</span><br>
                                            <span style="color:#003366;font-weight:bold">function</span> stats<span style="color:#008800;font-weight:bold">(</span><span style="color:#008800;font-weight:bold">)</span> <span style="color:#008800;font-weight:bold">{</span><br>
                                              <span style="color:#003366;font-weight:bold">var</span> nowDiff = <span style="color:#008800;font-weight:bold">(</span><span style="color:#003366;font-weight:bold">new</span> Date<span style="color:#008800;font-weight:bold">(</span><span style="color:#008800;font-weight:bold">)</span><span style="color:#008800;font-weight:bold">)</span>.<span style="color:#006600">getTime</span><span style="color:#008800;font-weight:bold">(</span><span style="color:#008800;font-weight:bold">)</span> - startTime;<br>
                                              <span style="color:#003366;font-weight:bold">var</span> perSec = Math.<span style="color:#006600">floor</span><span style="color:#008800;font-weight:bold">(</span>processed/nowDiff*<span style="color:#CC0000">1000</span><span style="color:#008800;font-weight:bold">)</span>;<br>
                                              postMessage<span style="color:#008800;font-weight:bold">(</span> <span style="color:#3366CC">"rate "</span> + perSec <span style="color:#008800;font-weight:bold">)</span>;<br>
                                            <span style="color:#008800;font-weight:bold">}</span>
                                        </p>
                                        <p>
                                            <span style="color:#009900;font-style:italic">// ... snip ...</span>
                                        </p>
                                        <p>
                                            <span style="color:#009900;font-style:italic">// Get the incoming information from the parent</span><br>
                                            onmessage = <span style="color:#003366;font-weight:bold">function</span><span style="color:#008800;font-weight:bold">(</span>e<span style="color:#008800;font-weight:bold">)</span><span style="color:#008800;font-weight:bold">{</span><br>
                                              <span style="color:#003366;font-weight:bold">var</span> parts = e.<span style="color:#006600">data</span>.<span style="color:#006600">split</span><span style="color:#008800;font-weight:bold">(</span><span style="color:#3366CC">" "</span><span style="color:#008800;font-weight:bold">)</span>;<br>
                                              data = <span style="color:#008800;font-weight:bold">{</span> sha: parts<span style="color:#008800;font-weight:bold">[</span><span style="color:#CC0000">0</span><span style="color:#008800;font-weight:bold">]</span>, words: parts<span style="color:#008800;font-weight:bold">[</span><span style="color:#CC0000">1</span><span style="color:#008800;font-weight:bold">]</span>.<span style="color:#006600">split</span><span style="color:#008800;font-weight:bold">(</span><span style="color:#3366CC">","</span><span style="color:#008800;font-weight:bold">)</span>, best: parts<span style="color:#008800;font-weight:bold">[</span><span style="color:#CC0000">2</span><span style="color:#008800;font-weight:bold">]</span> <span style="color:#008800;font-weight:bold">}</span>;<br>
                                              start<span style="color:#008800;font-weight:bold">(</span><span style="color:#008800;font-weight:bold">)</span>;<br>
                                            <span style="color:#008800;font-weight:bold">}</span>;
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <p>
                                The two 'distance' checks take place deep in the computation logic. After a new match has been found it is compared against the existing high scores. If this a sufficiently good-enough the result is sent back to the parent page using <code>postMessage</code>.
                            </p>
                            <p>
                                The 'stats' function is called periodically, which then reports back the current rate of processing to the parent page.
                            </p>
                            <p>
                                The 'onmessage' callback listens for the initialization data to come from the parent page - and once it's been received begins processing.
                            </p>
                            <p>
                                --
                            </p>
                            <p>
                                In all I found this project to be a lot of fun - a relatively minor amount of code yielded 2-3x faster computation power. If you're doing any computation with JavaScript you should definitely opt to use Web Workers if they're available - the result is both faster and a better experience for the end user.
                            </p><img src="http://ejohn.org/apps/rss/?from=rss&amp;id=5691" style="width:0px;height:0px">
                        </blockquote>
                    </div>
                    <p class="bookmark-source">
                        Source: <a href="http://ejohn.org/blog/web-workers/">http://ejohn.org/blog/web-workers/</a>
                    </p>
                </div>
            </article>

            <nav id="post-nav">


            </nav>
        </section>

        <footer id="site-footer" class="nocontent">
            <p>
                This site is purely my personal work and does not reflect the
                views of my employer.
            </p>
            <p class="license">
                <a class="icon" rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width: 0" src="https://i.creativecommons.org/l/by-sa/3.0/88x31.png"></a>
                This work is licensed under a
                <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative Commons Attribution-ShareAlike 3.0 Unported
                    License</a>.
            </p>
        </footer>

        <script async src="/static/js/common.js"></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/run_prettify.min.js" integrity="sha256-hj+5FRlAuvAFANiefn0PpJYCkV1X4QT9EgiPd+6QnCw=" crossorigin="anonymous"></script>
    </body>
</html>
