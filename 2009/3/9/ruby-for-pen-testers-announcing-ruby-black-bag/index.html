<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Ruby for Pen-Testers: Announcing Ruby Black Bag</title>
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <link rel="stylesheet" href="/static/css/main.min.css" type="text/css" media="all">
        <!--[if lte IE 8]>
            <link
                rel="stylesheet"
                href="/static/css/ie-fixes.css"
                type="text/css"
                media="all"
            />
            <script src="/static/js/html5shiv.js"></script>
        <![endif]-->

        <meta http-equiv="last-modified" content="Mon, 09 Mar 2009 20:32:14 GMT">
        <link rel="alternate" type="application/atom+xml" title="All Posts (Atom)" href="/feeds/all.atom">
        <link rel="alternate" type="application/rss+xml" title="All Posts (RSS)" href="/feeds/all.rss">
        <link rel="icon" type="image/jpeg" sizes="287x287" href="/static/img/favicon-287x287.jpg">
        <link rel="icon" type="image/jpeg" sizes="128x128" href="/static/img/favicon-128x128.jpg">
    </head>
    <body class="blog post_detail" itemscope itemtype="http://schema.org/BlogPosting">
        <nav id="site-nav">
            <header id="about">
                <h1><a href="/about/">Chris Adams</a></h1>
                <h2>Programmer, cyclist, photographer</h2>
            </header>
            <ul class="links">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about/">About</a>
                </li>
                <li>
                    <a href="/feeds/all.atom" title="Site Feed">Site Feed</a>
                </li>
            </ul>
            <ul class="social-networks">
                <li>
                    <a rel="me" href="https://code4lib.social/@acdha">Mastodon</a>
                </li>
                <li>
                    <a href="https://github.com/acdha" rel="me">Github</a>
                </li>
                <li>
                    <a href="https://bitbucket.org/acdha" rel="me">Bitbucket</a>
                </li>
                <li>
                    <a href="https://pinboard.in/u:acdha/" rel="me">Pinboard</a>
                </li>
                <li>
                    <a href="https://www.flickr.com/photos/acdha" rel="me">Flickr</a>
                </li>
                <li>
                    <a href="https://www.linkedin.com/in/acdha" rel="me">LinkedIn</a>
                </li>
            </ul>
            <div id="site-search"></div>
        </nav>
        <section id="main">
            <article class="post">
                <header>
                    <meta itemprop="dateCreated" content="2009-03-09T16:32:14-04:00">
                    <meta itemprop="dateModified" content="2009-03-09T16:32:14-04:00">
                    <time class="date" itemprop="datePublished" datetime="2009-03-09T20:32:14+00:00">Mar 09</time>
                    <h2 class="" itemprop="title">Ruby for Pen-Testers: Announcing Ruby Black Bag</h2>
                </header>

                <div class="body" itemprop="articleBody"><div class="googlereader description" data-google-id="tag:google.com,2005:reader/item/de1681f138aa4565">
                        <blockquote>
                            <p>
                                <img src="http://github.com/emonti/rbkb/raw/master/doctor-bag.jpg" alt="black bag-o-tools" width="449" height="300">
                            </p>
                            <p>
                                This post is part of an informal series discussing the Ruby programming language for various tasks related to penetration testing. Many of us at Matasano do a lot of our coding in Ruby. We like using it when we need to write our own tools (which we do frequently) because it helps us rapidly get off the ground doing all kinds of bespoke things that would be more tedious and time-consuming (or even impossible) using off-the-shelf tools. Go ahead! Call us fanboys (and girls!!!). We can live with it. We want to share some practical tips based on our experiences in this realm.
                            </p>
                            <h2>
                                Introducing, Ruby BlackBag (rbkb).
                            </h2>
                            <p>
                                ‘rbkb’ is an ever growing collection of reversing and pen-testing related ruby libraries and tools I’ve been using and evolving for a long time now. It’s at version 0.6.2 by my arbitrary version numbering scheme. I recently decided to gem-ify rbkb and make it public. This was mostly so I could get to it myself more easily when i needed to. A bit to my suprise, it seems to have kicked up some interest. So I figured I should give it a proper announcement here on our blog without further ado.
                            </p>
                            <h3>
                                Rationale
                            </h3>
                            <div>
                                Disclaimer: Most of what's in the black bag came from a desire to do less typing. But there might be a few clever things that were added by accident.
                            </div>
                            <p>
                                rbkb was originally inspired by <a href="http://www.matasano.com/log/552/code-release-blackbag-09-binary-protocol-reversing-unix-thingies/">Matasano BlackBag</a> (a set of similar tools written in C).
                            </p>
                            <p>
                                Here’s a <a href="http://github.com/emonti/rbkb/raw/master/reference/blackbag-0.9.1.tgz">rbkb backup link</a> to the latest version of blackbag, in-case you’re interested.
                            </p>
                            <p>
                                Things go into the black bag as they are stolen (as a compliment!) or dreamed up, usually for simplifying some repetetive task or a desire for a new tool.
                            </p>
                            <p>
                                Along the way, some of tools in the blackbag spirit make their way into ‘rbkb’ that may or may not make it to ‘bkb’ right away (if ever). Similarly some of the things in ‘bkb’ have not yet made it to ‘rbkb’ (and may not).
                            </p>
                            <h2>
                                Command Line Tools
                            </h2>
                            <div>
                                Usage: b64 [options] &lt;data | blank for stdin&gt; bgrep [options] &lt;subject&gt; &lt;file | blank for stdin&gt; blit [options] &lt;data | blank for stdin&gt; c 100 A; # print 100 A's' crc32 [options] d64 [options] &lt;data | blank for stdin&gt; dedump [options] &lt;input-file | blank for stdin&gt; hexify [options] &lt;data | blank for stdin&gt; len [options] &lt;data | blank for stdin&gt; plugsrv [options] target:tport[@[laddr:]lport] rstrings [options] &lt;file | blank for stdin&gt; slice [options] start (no args when using -r|-x) telson [options] host:port unhexify [options] &lt;data | blank for stdin&gt; urldec [options] &lt;data | blank for stdin&gt; urlenc [options] &lt;data | blank for stdin&gt; xor [options] -k|-s &lt;key&gt; &lt;data | stdin&gt;
                            </div>
                            <p>
                                <em><strong>Note:</strong> <a href="http://github.com/emonti/rbkb/blob/master/cli_usage.rdoc">See this page</a> for an up to date intro.</em>
                            </p>
                            <h2>
                                Plug
                            </h2>
                            <p>
                                Ruby Black Bag includes several tools for testing network protocols using plugboard proxies. Users of the original Matasano BlackBag may be familiar with the commands ‘bkb replug’, ‘bkb telson’, and ‘bkb blit’. Ruby BlackBag has a similar set of network tools:
                            </p>
                            <ul>
                                <li>‘blit’ : Uses a simple homegrown OOB IPC mechanism (local socket) to communicate with ‘blit-capable’ tools like telson and plugsrv and send data to network endpoints through them. Use ‘blit’ to send raw messages to servers or clients then watch how they respond (see below).
                                </li>
                                <li>‘telson’ : Similar to ‘bkb telson’. Opens a TCP or UDP client connection which is little more than a receiver for ‘blit’ messages. Use this to pretend to be a client and send raw messages to some service while observing raw replies.
                                </li>
                                <li>‘plugsrv’ : Similar to ‘bkb replug’. Sits as a reverse TCP proxy between one or more clients and a server. Accepts ‘blit’ messages which can be directed at client or server ends of a conversation. The original ‘replug’ didn’t do this, which makes plugsrv kind-of neat.
                                </li>
                            </ul>
                            <h2>
                                Monkey Patches
                            </h2>
                            <p>
                                Much of rbkb is implemented as a bunch of monkeypatches to Array, String, Numeric, Object and other base classes. If this suits your fancy (some people despise monkeypatches, this is not their fancy) then you can ‘require “rbkb”’ from your irb sessions and own scripts. See ‘lib_fun.rdoc’ for more info.
                            </p>
                            <h3>
                                Obligatory Demos:
                            </h3>
                            <p>
                                My dirty secret: I use IRB for like… everything!
                            </p>
                            <p>
                                The monkey-patches were designed to let you approximate use of the rbkb shell commands from IRB or ruby scripts.
                            </p>
                            <p>
                                Using the rbkb library in ruby will let you do things like the following:
                            </p>
                            <div>
                                # Right, um. this first! require 'rubygems' require 'rbkb'
                            </div>
                            <p>
                                Do stuff with strings:
                            </p>
                            <div>
                                ## sexify with hexify foo = "helu foo" #=&gt; "helu foo" foo.hexify #=&gt; "68656c7520666f6f" ## a little easier to read foo.hexify(:delim =&gt; ' ') #=&gt; "68 65 6c 75 20 66 6f 6f" # and back _.unhexify #=&gt; "helu foo" ## break out your hexdump -C styles foodump = "helu foo".hexdump(:out =&gt; StringIO.new) #=&gt; "00000000 68 65 6c 75 20 66 6f 6f |helu foo|\n00000008\n" puts foodump # 00000000 68 65 6c 75 20 66 6f 6f |helu foo| # 00000008 # =&gt; nil foo.hexdump(:out =&gt; $stdout) # 00000000 68 65 6c 75 20 66 6f 6f |helu foo| # 00000008 # =&gt; nil ## reverse a hexdump foodump.dehexdump #=&gt; "helu foo" ## 'strings' like /usr/bin/strings dat = File.read("/bin/ls") pp dat.strings # [[4132, 4143, :ascii, "__PAGEZERO00"], # [4188, 4195, :ascii, "__TEXT00"], # ... # [72427, 72470, :ascii, "*Apple Code Signing Certification Authority"], # [72645, 72652, :ascii, "X[N~EQ "]] ## look for stuff in binaries dat.bgrep("__PAGEZERO") #=&gt; [[4132, 4142, "__PAGEZERO"], [40996, 41006, "__PAGEZERO"]] dat.bgrep(0xCAFEBABE.to_bytes) #=&gt; [[0, 4, "\312\376\272\276"]]
                            </div>
                            <p>
                                Do stuff with numbers:
                            </p>
                            <div>
                                ## Do you have an irrational distaste for pack/unpack? I do. 0xff.to_bytes #=&gt; "000000\377" be = 0xff.to_bytes(:big) #=&gt; "000000\377" le = 0xff.to_bytes(:little) #=&gt; "\377000000" le16 = 0xff.to_bytes(:little,2) #=&gt; "\37700" ## Strings can go the other way too [be, le, le16].map {|n| n.dat_to_num(:big) } # default #=&gt; [255, 4278190080, 65280] [be, le, le16].map {|n| n.dat_to_num(:little) } #=&gt; [4278190080, 255, 255] ## Calculate padding for a given alignment 10.pad(16) #=&gt; 6 16.pad(16) #=&gt; 0 30.pad(16) #=&gt; 2 32.pad(16) #=&gt; 0
                            </div>
                            <p>
                                Interact with ‘telson’ and ‘plugsrv’ directly from IRB:
                            </p>
                            <div>
                                ## In a separate window from your irb session do something like: # # $ telson rubyforge.com:80 -r # ** BLITSRV-127.0.0.1:25195(TCP) Started # ** TELSON-....:58118(TCP) CONNECTED TO PEER-....:80(TCP) ## You can blit any string from within IRB! ## A minor setup step is required... (I put this in my .irbrc) Plug::Blit.blit_init #=&gt; nil "GET / HTTP/1.0\r\n\r\n".blit #=&gt; 28 ## Watch the basic HTTP request get made and responded to in the ## other window. ("GET /"+ "A"*30 +" HTTP/1.0\r\n\r\n").blit #=&gt; 58 ## Watch the bogus HTTP request get made and responded to in the ## other window.
                            </div>
                            <p>
                                Some simple web encoding helpers:
                            </p>
                            <div>
                                xss="&lt;script&gt;alert('helu ' + document.cookie)&lt;/script&gt;" # URL percent-encode stuff xss.urlenc #=&gt; "%3cscript%3ealert%28%27helu%3a%20%27%20%2b%20document. # cookie%29%3c%2fscript%3e" # Base64 encode stuff _.b64 #=&gt; "JTNjc2NyaXB0JTNlYWxlcnQlMjglMjdoZWx1JTNhJTIwJTI3JTIwJTJiJTIwZG9 # jdW1lbnQuY29va2llJTI5JTNjJTJmc2NyaXB0JTNl" ## And back _.d64 #=&gt; "%3cscript%3ealert%28%27helu%3a%20%27%20%2b%20document. # cookie%29%3c%2fscript%3e" _.urldec #=&gt; "&lt;script&gt;alert('helu: ' + document.cookie)&lt;/script&gt;"
                            </div>
                            <p>
                                Miscellaneous stuff:
                            </p>
                            <div>
                                # featuring rediculous laziness! 0x41.printable? #=&gt; true 0x01.printable? #=&gt; false # Make random gobbledygook and insults "helu foo".randomize #=&gt; "ouofleh " "helu foo".randomize #=&gt; "foul hoe"
                            </div>
                            <p>
                                Pretend (badly) to be smart:
                            </p>
                            <div>
                                # Cletus say's he's "sneaky" cletus = "my secrets are safe".xor("sneaky") #=&gt; "3627E22163201\v2122K3001\vE22\n3726" # Only not really so sneaky cletus.xor "my secrets" #=&gt; "sneakysnea&amp;a!x qxzb" cletus.xor "my secrets are" #=&gt; "sneakysneakysn(k*ls" cletus.xor "sneaky" #=&gt; "my secrets are safe" # Now make Cletus feel worse. With... MATH! # (ala entropy scores) "A".entropy #=&gt; 0.0 "AB".entropy #=&gt; 1.0 "BC".entropy #=&gt; 1.0 (0..255).map {|x| x.chr}.join.entropy #=&gt; 8.0 # "You see, Cletus, you might have done this..." sdat = "my secrets are very secret "*60 require 'openssl' c = OpenSSL::Cipher::Cipher.new("aes-256-cbc") c.encrypt c.key = Digest::SHA1.hexdigest("sneaky") c.iv = c.random_iv # "So, Cletus, when you say 'sneaky'... this is exactly how 'sneaky' you are" c.update(sdat).entropy #=&gt; 7.64800383393901 sdat.xor("sneaky").entropy #=&gt; 3.77687372599433 sdat.entropy #=&gt; 3.07487577558377
                            </div>
                            <p>
                                <strong>Note:</strong> <a href="http://github.com/emonti/rbkb/blob/master/lib_usage.rdoc">This page</a> may have more up to date information depending on when you read this.
                            </p>
                            <p>
                                I recommend installing the gem and clicking around rdoc if you’re interested in more of these little helpers and how some of the cli tools use the library. Time permitting, my goal is to try to keep the docs useful and up to date.
                            </p>
                            <h3>
                                Interested?
                            </h3>
                            <p>
                                Head over to <a href="http://www.github.com/emonti/rbkb">the github page for ‘rbkb’</a>.
                            </p>
                            <h3>
                                Comments Welcome
                            </h3>
                            <p>
                                Constructive comments and feedback are welcome. Just remember this just kinda sprang up out of project work. There are no doubt lots of bugs and rough edges but I’m interested in polishing it up.
                            </p>
                        </blockquote>
                    </div>
                    <p class="bookmark-source">
                        Source: <a href="http://www.matasano.com/log/1473/ruby-for-pen-testers-announcing-ruby-black-bag/">http://www.matasano.com/log/1473/ruby-for-pen-testers-announcing-ruby-black-bag/</a>
                    </p>
                </div>
            </article>

            <nav id="post-nav">


            </nav>
        </section>

        <footer id="site-footer" class="nocontent">
            <p>
                This site is purely my personal work and does not reflect the
                views of my employer.
            </p>
            <p class="license">
                <a class="icon" rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width: 0" src="https://i.creativecommons.org/l/by-sa/3.0/88x31.png"></a>
                This work is licensed under a
                <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative Commons Attribution-ShareAlike 3.0 Unported
                    License</a>.
            </p>
        </footer>

        <script async src="/static/js/common.js"></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/run_prettify.min.js" integrity="sha256-hj+5FRlAuvAFANiefn0PpJYCkV1X4QT9EgiPd+6QnCw=" crossorigin="anonymous"></script>
    </body>
</html>
