<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>
            A Four-Day Dive Into Stuxnet’s Heart
        </title>
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <link rel="stylesheet" href="/static/css/main.min.css" type="text/css" media="all"><!--[if lte IE 8]>
            <link rel="stylesheet" href="/static/css/ie-fixes.css" type="text/css" media="all">
            <script src="/static/js/html5shiv.js"></script>
        <![endif]-->
        <meta http-equiv="last-modified" content="Tue, 28 Dec 2010 04:18:39 GMT">
        <link rel="alternate" type="application/atom+xml" title="All Posts (Atom)" href="/feeds/all.atom">
        <link rel="alternate" type="application/rss+xml" title="All Posts (RSS)" href="/feeds/all.rss">
        <link rel="icon" type="image/jpeg" sizes="287x287" href="/static/img/favicon-287x287.jpg">
        <link rel="icon" type="image/jpeg" sizes="128x128" href="/static/img/favicon-128x128.jpg">
        <script type="application/javascript">
var _prum={id:"5166be01e6e53d1007000001"};var PRUM_EPISODES=PRUM_EPISODES||{};PRUM_EPISODES.q=[];PRUM_EPISODES.mark=function(b,a){PRUM_EPISODES.q.push(["mark",b,a||new Date().getTime()])};PRUM_EPISODES.measure=function(b,a,b){PRUM_EPISODES.q.push(["measure",b,a,b||new Date().getTime()])};PRUM_EPISODES.done=function(a){PRUM_EPISODES.q.push(["done",a])};PRUM_EPISODES.mark("firstbyte");(function(){var b=document.getElementsByTagName("script")[0];var a=document.createElement("script");a.type="text/javascript";a.async=true;a.charset="UTF-8";a.src="//rum-static.pingdom.net/prum.min.js";b.parentNode.insertBefore(a,b)})();
        </script>
    </head>
    <body class="blog post_detail" itemscope itemtype="http://schema.org/BlogPosting">
        <nav id="site-nav">
            <header id="about">
                <h1>
                    <a href="/about/">Chris Adams</a>
                </h1>
                <h2>
                    Programmer, cyclist, photographer
                </h2>
            </header>
            <ul class="links">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/about/">About</a>
                </li>
                <li>
                    <a href="/feeds/all.atom" title="Site Feed">Site Feed</a>
                </li>
            </ul>
            <ul class="social-networks">
                <li>
                    <a href="https://github.com/acdha" rel="me">Github</a>
                </li>
                <li>
                    <a href="http://bitbucket.org/acdha" rel="me">Bitbucket</a>
                </li>
                <li>
                    <a href="http://delicious.com/acdha" rel="me">del.icio.us</a>
                </li>
                <li>
                    <a href="http://twitter.com/acdha" rel="me">Twitter</a>
                </li>
                <li>
                    <a href="https://plus.google.com/116562742092842686896?rel=author" rel="me">Google+</a>
                </li>
                <li>
                    <a href="http://www.flickr.com/photos/acdha" rel="me">Flickr</a>
                </li>
                <li>
                    <a href="http://www.linkedin.com/in/acdha" rel="me">LinkedIn</a>
                </li>
                <li>
                    <a href="http://connect.garmin.com/explore?owner=acdha" rel="me">Garmin Connect</a>
                </li>
            </ul>
            <div id="site-search"></div>
        </nav>
        <section id="main">
            <article class="post">
                <header>
                    <meta itemprop="dateCreated" content="2010-12-27T23:18:39-04:00">
                    <meta itemprop="dateModified" content="2010-12-27T23:18:39-04:00"><time class="date" itemprop="datePublished" datetime="2010-12-28T03:18:39+00:00">Dec 28</time>
                    <h2 itemprop="title">
                        A Four-Day Dive Into Stuxnet’s Heart
                    </h2>
                </header>
                <div class="body" itemprop="articleBody">
                    <div class="googlereader description" data-google-id="tag:google.com,2005:reader/item/125724be80018d26">
                        <p class="annotation">
                            Really highlights the cost of Microsoft's security-by-throwing-code-monkeys approach versus good design. Imagine if the win32 guys hadn't thrown away the good ideas Cutler's team provided?
                        </p>
                        <blockquote>
                            <div style="width:210px">
                                <a rel="attachment wp-att-22269" href="http://www.wired.com/threatlevel/2010/12/a-four-day-dive-into-stuxnets-heart/dang-2/"><img title="Dang" src="http://www.wired.com/images_blogs/threatlevel/2010/12/Dang1-200x300.jpg" alt="" width="200" height="300"></a>
                                <p>
                                    Bruce Dang, the software engineer who led Microsoft's analysis of the Stuxnet worm.
                                </p>
                            </div>
                            <p>
                                BERLIN, Germany — It is a mark of the extreme oddity of the Stuxnet computer worm that Microsoft’s Windows vulnerability team learned of it first from an obscure Belarusian security company that even they had never heard of.
                            </p>
                            <p>
                                The sophisticated worm, which many computer experts believe was created as an attempt to <a href="http://www.wired.com/threatlevel/2010/12/isis-report-on-stuxnet/">specifically sabotage Iran’s nuclear power plant centrifuges</a>, has written a new chapter in the history of computer security. Written to affect specific Siemens components used at Iran’s facilities, some analysts have even speculated it may have been the <a href="http://www.wired.com/threatlevel/2010/10/stuxnet-deconstructed/">work of a state</a>, rather then of traditional underground virus-writers.
                            </p>
                            <p>
                                Much of the attention has focused on the worm’s origin and ultimate effects. But in a standing-room session at the <a href="http://www.wired.com/threatlevel/2010/12/hackers-watch-a-world-collapsing-into-chaos/">Chaos Computer Club (CC) Congress</a> here today, Microsoft’s lead vulnerability analyst on the Stuxnet project offered a blow-by-blow account of the software company’s response and analysis to the software’s multipronged attack on Windows vulnerabilities.
                            </p>
                            <p>
                                Much of the technical side – which flaws were attacked, and how they were fixed – are now well known. But the story offered unusual insight into the software company’s race to stay ahead of the security firms seeking themselves to peel back the worm’s layers of attacks, and the intense pressure put on the team of analysts.
                            </p>
                            <p>
                                “We knew a lot of other people were looking, and it’s important to us to know the details before other companies,” said Bruce Dang, the security software engineer in Microsoft’s Security Response Center who led the analysis. “(Management) is smart, they know it takes time, but they want results.”
                            </p>
                            <p>
                                The public Stuxnet story began when Belarusian firm VirusBlokAda first identified the Stuxnet code in June, and contacted Microsoft with a PDF showing the screenshot of the effects. Dang said his team was initially tempted to dismiss the report, thinking it a common and known problem, but a case was opened, and once a team began looking at the code, they realized it was something new.
                            </p>
                            <p>
                                The code that had been provided to the team was large – close to 1 MB of information, Dang said. A team of 20 to 30 people with expertise in various components of the Windows system was assembled and began quickly exchanging emails.
                            </p>
                            <p>
                                They traced the apparent problem to code that came from an infected USB stick. By exploiting a vulnerability in the Windows icon shortcut feature, or .LNK files, the worm gained the ability to execute commands on the infected computer, but only with the current user’s level of access.
                            </p>
                            <p>
                                Several fixes were proposed, and others in the company turned down those that would have contradicted messages already provided to outside developers. Dang said the urgency was nevertheless high, because the company was getting reports of considerable numbers of infection, and the vulnerability turned out to be extremely simple to use.
                            </p>
                            <p>
                                “A seven-year-old could exploit this. It’s bad news,” Dang said. “Of course it turned out that this vulnerability had been known for several years by some people, but no one told me.”
                            </p>
                            <p>
                                Case closed. They thought they were finished. But as Dang and another colleague began doing a bit of further analysis, they noticed that extra drivers were being installed on their test computers, both in Windows XP and Windows 7 environments. This was definitely not good, they thought.
                            </p>
                            <p>
                                Closer investigation showed that scheduled tasks were being added, and XML-based task files were being created and rewritten. Working with a colleague overseas, Dang discovered that the way Windows Vista and later operating systems stored and verified scheduled tasks contained a vulnerability that would give the attacking worm – which had already gained the ability to drop code with user-based access privileges – the ability to give itself far broader, and thus more dangerous, privileges on the infected computer.
                            </p>
                            <p>
                                In short, the two flaws working together allowed the worm to gain code execution privileges, and then to deepen those privileges to install a rootkit.
                            </p>
                            <p>
                                The team thought again about how to fix the problem, and settled on changing the way the Vista and Windows 7 task scheduler uses hash values to verify files. Once implemented, this would block the dangerous privilege escalation.
                            </p>
                            <p>
                                Finished, then? Not yet. Dang’s colleague noted that a particular DLL, or system file, was being loaded in a suspicious way. They looked harder, and saw it was happening differently in XP and Windows 7 system. But they couldn’t figure this one out immediately.
                            </p>
                            <p>
                                Dang started going over the binary code line by line, but with over 1000 lines, he realized this tactic simply wasn’t going to be fast enough. Management was putting severe pressure on the team to get results, and they had no answers.
                            </p>
                            <p>
                                He took this one home. He stayed up brainstorming until the small hours of the night, but all his ideas came to nothing. He even tried just letting the exploit run, on the theory that most virus code isn’t perfect, and will ultimately cause a blue-screen system crash, exposing the problem in the crash logs. But no dice – this one ran perfectly 10 times in a row.
                            </p>
                            <p>
                                “I knew we were getting close,” he said. “I knew it was searching for something, but exactly what wasn’t clear to me.”
                            </p>
                            <p>
                                The next day, an old kernel debugger analysis trick finally paid off. The team identified a flaw in the way Windows XP systems are allowed to switch user keyboard layouts – from an English keyboard to a German configuration, for example. Once again, this allowed the worm to gain elevated privileges on the infected computer.
                            </p>
                            <p>
                                Smart – almost chillingly so, Dang said. The task scheduling attack previously identified worked only on Vista and later systems. The keyboard layout attack worked only on XP. Somebody somewhere had set their sights very broadly.
                            </p>
                            <p>
                                “We felt pretty good at that point,” he said. “How could there be more?”
                            </p>
                            <p>
                                But there was more. The team got word from the Kaspersky Lab security company that there was strange “remote procedure call” traffic being sent over a network – a kind of communication that allows one computer to trigger activity on another, such as printing from a remote device.
                            </p>
                            <p>
                                Dang and his team set up a mini-VPN, infected one computer, and went away. They came back to find their entire mini-network had been infected.
                            </p>
                            <p>
                                “I said, what the f***, this is really weird,” Dang said.
                            </p>
                            <p>
                                They brought Microsoft’s printer team in, and this time the problem proved simple to uncover. In five minutes they had traced the source – a print spooler flaw that allowed remote guest accounts to write executable files directly to disk. A terrible flaw, but luckily fixed quickly.
                            </p>
                            <p>
                                The flaw gave more insight into the attacker’s intentions – the configuration vulnerable to this flaw was very uncommon in normal corporations, but allowed widespread infection within a network that was configured in this way, Dang said.
                            </p>
                            <p>
                                From the perspective of Microsoft’s vulnerability team, the story essentially ends there. But Stuxnet has been in the wild for a year, and revelations continue as to the breadth of the infection, and the sophistication of its apparent attack on Iran’s nuclear centrifuges.
                            </p>
                            <p>
                                Dang says several things are clear from his reading of the code. It was written by at least several people, with the different components bearing the fingerprints of different authors. And the creators were careful to make sure that it ran perfectly, with high impact and 100 percent reliability, he said – a goal even commercial software developers often fail to meet.
                            </p>
                            <p>
                                The total time taken from discovery to the final fix was between three and four days, or about 40 Microsoft person-hours. But the effects of this sophisticated exploitation of unknown or “zero-day” Windows vulnerabilities will surely continue to resonate for months or even years to come.
                            </p>
                            <p>
                                <br>
                            </p>
                            <div>
                                <a href="http://feeds.wired.com/~ff/wired27b?a=V-08KKWgUZ8:r5cBnX1XntY:cGdyc7Q-1BI"><img src="http://feeds.feedburner.com/~ff/wired27b?d=cGdyc7Q-1BI" border="0"></a> <a href="http://feeds.wired.com/~ff/wired27b?a=V-08KKWgUZ8:r5cBnX1XntY:V_sGLiPBpWU"><img src="http://feeds.feedburner.com/~ff/wired27b?i=V-08KKWgUZ8:r5cBnX1XntY:V_sGLiPBpWU" border="0"></a> <a href="http://feeds.wired.com/~ff/wired27b?a=V-08KKWgUZ8:r5cBnX1XntY:gIN9vFwOqvQ"><img src="http://feeds.feedburner.com/~ff/wired27b?i=V-08KKWgUZ8:r5cBnX1XntY:gIN9vFwOqvQ" border="0"></a> <a href="http://feeds.wired.com/~ff/wired27b?a=V-08KKWgUZ8:r5cBnX1XntY:yIl2AUoC8zA"><img src="http://feeds.feedburner.com/~ff/wired27b?d=yIl2AUoC8zA" border="0"></a>
                            </div>
                        </blockquote>
                    </div>
                    <p class="bookmark-source">
                        Source: <a href="http://feeds.wired.com/~r/wired27b/~3/V-08KKWgUZ8/">http://feeds.wired.com/~r/wired27b/~3/V-08KKWgUZ8/</a>
                    </p>
                </div>
            </article>
            <nav id="post-nav"></nav><script id="discus-javascript">
    var disqus_shortname = 'improbable';

                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    document.getElementsByTagName('body')[0].appendChild(dsq);
                })();
            </script><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            <div id="disqus_thread"></div>
        </section>
        <footer id="site-footer" class="nocontent">
            <p>
                This site is purely my personal work and does not reflect the views of my employer.
            </p>
            <p class="license">
                <a class="icon" rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png"></a> This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.
            </p>
        </footer><script async="" defer src="/static/js/common.js">
</script><script id="google-analytics">
    var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-2097834-1']);
            _gaq.push(['_setDomainName', 'improbable.org']);
            _gaq.push(['_trackPageview']);

            (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();
        </script>
    </body>
</html>
